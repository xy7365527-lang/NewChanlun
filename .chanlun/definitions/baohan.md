# K线包含处理（Baohan / Inclusion Merge）

**版本**: v1.1
**状态**: 已结算
**最后更新**: 2026-02-15
**变更**:
- v1.1 结算"单条件 vs 双条件"问题：回溯原文证实两者逻辑等价
**原文依据**: 编纂版 §四；博文第62课

---

## 定义

### 包含关系

两根K线存在包含关系，当且仅当一根K线的高低点区间完全在另一根K线范围内。

形式化：K1 包含 K2 当 `K1.high >= K2.high AND K1.low <= K2.low`。
反之 K2 包含 K1 当 `K2.high >= K1.high AND K2.low <= K1.low`。
任一成立即为"存在包含关系"。

> 注意：只关心 high 和 low 两个价位，不看 open/close。

### 合并方向

当相邻两根K线存在包含关系时，需要确定合并方向。方向由此前最近一对**无包含关系**的相邻K线决定：

**原文（编纂版 §四 L17）**：
> 第n根与第n-1根不是包含关系，如果第n根K线的高点大于第n-1根K线的高点，则称向上；如果第n根K线的低点小于第n-1根K线的低点，则称向下。

形式化（单条件写法）：
- `high_n > high_{n-1}` → dir = UP
- `low_n < low_{n-1}` → dir = DOWN

**代码实现（双条件写法）**：
- `high_i > high_{i-1} AND low_i > low_{i-1}` → dir = UP
- `high_i < high_{i-1} AND low_i < low_{i-1}` → dir = DOWN
- 否则 dir 保持不变

**等价性证明**（v1.1 结算）：
原文前提"第n根与第n-1根**不是包含关系**"是关键。在 `>=` 包含判定下，非包含的相邻K线对**只有两种可能**：
1. `high↑ AND low↑`（整体上移）→ 单条件和双条件都判为 UP
2. `high↓ AND low↓`（整体下移）→ 单条件和双条件都判为 DOWN

不可能出现 `high↑ AND low↓`（这是右包含左）或 `high↓ AND low↑`（这是左包含右），因为这些情况已被包含判定捕获。因此**单条件与双条件在逻辑上完全等价**，代码的双条件只是更防御性的写法，不影响结果。

**初始方向**：dir 初始为 None。遇到包含关系时 dir 仍为 None → 默认按 UP 合并。

### 合并规则

- **向上合并**：`new_high = max(h1, h2)`, `new_low = max(l1, l2)`
- **向下合并**：`new_high = min(h1, h2)`, `new_low = min(l1, l2)`
- **OHLC 工程处理**：`open = 左K.open`, `close = 右K.close`

### 顺序原则

**先左后右**递推：
1. 从第1根K线开始，依次检查后续K线
2. 若当前 merged bar 与新K线存在包含关系 → 合并
3. 否则 → 更新 dir（满足条件时），新K线作为新的 merged bar
4. 完成后序列无任何相邻包含关系

**性质**（编纂版 §四 推论）：
- 包含处理遵守结合律
- 不遵守传递律（A 包含 B 且 B 包含 C，不代表 A 包含 C）

## 输出

- `df_merged`: 包含处理后的K线序列（无相邻包含）
- `merged_to_raw: list[tuple[int, int]]`: 每根 merged bar 对应原始K线的位置范围（闭区间）

`merged_to_raw` 是新笔间距计算的关键数据来源。

## 当前实现

- **文件**: `src/newchan/a_inclusion.py :: merge_inclusion`
- **方向判定**: 双条件（与单条件逻辑等价，见上方证明）
- **初始方向**: None → 默认按 UP 合并
- **输出**: `(df_merged, merged_to_raw)`

## 边界条件

- 空输入 → 返回空 DataFrame 和空列表
- 单根K线 → 原样返回，`merged_to_raw = [(0, 0)]`
- 相邻K线 high 或 low 恰好相等 → 视为包含（`>=`，非严格大于）
- 连续多根包含 → 持续合并到同一个 merged bar 中
- 代码中"高低一升一降"的 else 分支是死代码（不可能到达），仅作防御保留

## 未结算问题

1. ~~**方向判定：单条件 vs 双条件**~~ **已结算**：两者在"非包含前提"下逻辑等价。
2. **等值边界**：`>=` vs `>` 的选择。当前用 `>=`（等值算包含）。原文（编纂版 §四 L5）只说"一K线的高低点**全在**另一K线的范围里"，未明确边界上的等号。`>=` 是保守选择（等值时合并），实际影响极小。暂按现状保留。

## 谱系引用

- 间接关联 001：包含处理的正确性影响分型识别 → 影响笔划分 → 影响退化段
- 间接关联新笔：`merged_to_raw` 是新笔间距计算的数据来源

## 影响声明

包含处理是整个管线的第一步。所有后续概念（分型、笔、线段、中枢、走势类型）建立在包含处理后的序列上。包含处理的正确性是整个系统的地基。`merged_to_raw` 的正确性直接影响新笔间距计算。
