# 笔（Bi / Stroke）

**版本**: v1.2
**状态**: 生成态（口径选择待结算）
**最后更新**: 2026-02-15
**变更**:
- v1.1 澄清新旧笔核心差异——计数基准（merged vs raw），非阈值数值
- v1.2 实证验证：旧笔产出退化段，新笔（模拟）消除退化段。mode="new" 已实现。
**原文依据**: 编纂版 §六；博文第62课、第65课；《忽闻台风可休市》

---

## 定义

笔是两个**相邻的、异性的**分型之间的连接。

- **上升笔**: 底分型 → 顶分型（方向 up）
- **下降笔**: 顶分型 → 底分型（方向 down）

笔是走势的最小可编码单元。所有高级别结构（线段、中枢、走势类型）以笔为原子部件。

## 成立条件

### 条件1：异性分型

起止必须是一顶一底（或一底一顶）。同性分型之间不成笔。

### 条件2：间距

**旧笔（当前实现）**：在**包含处理后**（merged）序列上计数。顶底分型之间至少有一根 merged bar 不属于顶分型与底分型。等价于 `cand.idx - start.idx >= 4`（merged bar 间距）。

**新笔（未启用）**：在**原始**（raw）K线上计数。原文（《忽闻台风可休市》L110）明确写"**不考虑包含关系**"。两个条件：
1. 顶底分型不共用K线（与旧笔相同）
2. 顶分型最高K线与底分型最低K线之间（不含这两根），在原始K线序列上至少有3根K线

**核心差异**：计数基准不同。包含处理压缩K线后，merged 间距可能 < 4，但原始K线间距可能 >= 3。新笔比旧笔宽松——旧笔下某些短促波动不成笔（merged 间距不足），但新笔下成笔（原始间距足够）。这减少了不合理的分型组合，从而消除古怪线段。

**实现路径**：`merge_inclusion()` 已返回 `merged_to_raw: list[tuple[int, int]]`。新笔间距 = `merged_to_raw[cand.idx][0] - merged_to_raw[start.idx][1] - 1 >= 3`。

> 口径选择是生成态矛盾。见谱系 001-degenerate-segment。

### 条件3：方向有效性

- 上升笔：终点价（顶分型极值） > 起点价（底分型极值）
- 下降笔：终点价（底分型极值） < 起点价（顶分型极值）

违反此条件的分型对不成笔。

## 划分规则（可编码）

1. 从分型序列中去重：同类相邻分型，保留更极端者（顶取更高，底取更低）
2. 强制顶底交替
3. 逐对检查：间距 + 方向有效性
4. 锁定规则：已成笔的终点不可被替换；遇同类更极端分型时，延伸当前笔（更新终点），不断开新笔
5. 最后一笔标记为未确认（confirmed=False），延伸中

## 当前实现

- **文件**: `src/newchan/a_stroke.py :: strokes_from_fractals`
- **口径**: 旧笔（wide模式，`gap >= 4` merged bars）
- **数据结构**: `Stroke` dataclass（frozen, slots）
- **字段**: i0, i1, direction, high, low, p0, p1, confirmed

## 边界条件

- 当间距恰好等于阈值时（边界上），成笔。`gap >= min_gap` 是闭区间。
- 两个分型共用K线但间距不足时，不成笔。
- 同类分型连续出现时，只保留最极端的一个，其余被丢弃。
- 最后一笔始终为 confirmed=False，直到下一笔生成后才结算。

## 未结算问题

1. ~~**旧笔 vs 新笔**~~ **已验证**：旧笔（7笔序列含回头波动）→ v1 产出退化段（up: ep1=99 < ep0=100）。精简笔序列（模拟新笔过滤）→ v1 正常（up: ep1=115 > ep0=100）。**新笔消除退化段的假说成立。** mode="new" 已实现（谱系 001 待正式结算）。
2. ~~**新笔的"3根K线"是否考虑包含关系**~~ **已澄清**：原文明确写"不考虑包含关系"，即在原始K线上计数。不再是争议项。
3. **wide vs strict 模式的语义**：wide（gap>=4 merged）= 旧笔。strict（gap>=5 merged）无原文对应，可能是经验值，待确认是否保留。
4. **何时切换默认值**：mode="new" 已可用但尚未设为默认。需要在真实市场数据上端到端验证后再切换。

## 谱系引用

- `001-degenerate-segment`：退化段问题可能源于笔定义口径选择
- `002-source-incompleteness`：笔定义的完整原文依据已补录
- `003-segment-concept-separation`：线段两口径的差异可能部分归因于笔层
