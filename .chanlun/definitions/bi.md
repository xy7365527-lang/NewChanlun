# 笔（Bi / Stroke）

**版本**: v1.0
**状态**: 生成态
**最后更新**: 2026-02-15
**原文依据**: 编纂版 §六；博文第62课、第65课；《忽闻台风可休市》

---

## 定义

笔是两个**相邻的、异性的**分型之间的连接。

- **上升笔**: 底分型 → 顶分型（方向 up）
- **下降笔**: 顶分型 → 底分型（方向 down）

笔是走势的最小可编码单元。所有高级别结构（线段、中枢、走势类型）以笔为原子部件。

## 成立条件

### 条件1：异性分型

起止必须是一顶一底（或一底一顶）。同性分型之间不成笔。

### 条件2：间距

**当前口径（旧笔）**：顶底分型之间至少有一根K线不属于顶分型与底分型。等价于：包含顶底在内，笔至少由5根包含处理后K线构成。

**新笔口径（未启用）**：顶分型最高K线与底分型最低K线之间（不含这两根K线），至少有3根K线。新笔条件比旧笔宽松——旧笔下成笔的某些短促波动在新笔下不成笔，从而消除导致古怪线段的分型组合。

> 口径选择是生成态矛盾。见谱系 001-degenerate-segment。

### 条件3：方向有效性

- 上升笔：终点价（顶分型极值） > 起点价（底分型极值）
- 下降笔：终点价（底分型极值） < 起点价（顶分型极值）

违反此条件的分型对不成笔。

## 划分规则（可编码）

1. 从分型序列中去重：同类相邻分型，保留更极端者（顶取更高，底取更低）
2. 强制顶底交替
3. 逐对检查：间距 + 方向有效性
4. 锁定规则：已成笔的终点不可被替换；遇同类更极端分型时，延伸当前笔（更新终点），不断开新笔
5. 最后一笔标记为未确认（confirmed=False），延伸中

## 当前实现

- **文件**: `src/newchan/a_stroke.py :: strokes_from_fractals`
- **口径**: 旧笔（wide模式，`gap >= 4` merged bars）
- **数据结构**: `Stroke` dataclass（frozen, slots）
- **字段**: i0, i1, direction, high, low, p0, p1, confirmed

## 边界条件

- 当间距恰好等于阈值时（边界上），成笔。`gap >= min_gap` 是闭区间。
- 两个分型共用K线但间距不足时，不成笔。
- 同类分型连续出现时，只保留最极端的一个，其余被丢弃。
- 最后一笔始终为 confirmed=False，直到下一笔生成后才结算。

## 未结算问题

1. **旧笔 vs 新笔**：当前实现为旧笔。新笔是否能消除退化段？需要实证验证。（谱系 001）
2. **新笔的"3根K线"是否考虑包含关系**：原文存在争议，本项目未确定口径。（谱系 001 待验证项）
3. **wide vs strict 模式的语义**：代码提供两种模式（gap>=4 和 gap>=5），与原文旧笔/新笔的映射关系需要厘清。

## 谱系引用

- `001-degenerate-segment`：退化段问题可能源于笔定义口径选择
- `002-source-incompleteness`：笔定义的完整原文依据已补录
- `003-segment-concept-separation`：线段两口径的差异可能部分归因于笔层
