# 笔（Bi / Stroke）

**版本**: v1.4
**状态**: 已结算
**最后更新**: 2026-02-16
**变更**:
- v1.4 /ritual 正式结算：真实数据E2E验证通过（AAPL 1分钟，177笔方向交替100%），001谱系结算
- v1.1 澄清新旧笔核心差异——计数基准（merged vs raw），非阈值数值
- v1.2 实证验证：旧笔产出退化段，新笔（模拟）消除退化段。mode="new" 已实现。
- v1.2.1 增加原文谱系
- v1.3 全管线集成测试通过（13/13）：inclusion→fractals→strokes + BiEngine 端到端。BiEngine merged_to_raw 传参缺陷已修复。
**原文依据**: 编纂版 §六；博文第62课、第65课；《忽闻台风可休市》

---

## 原文谱系

笔概念在缠师108课中经历了从**旧笔到新笔**的完整演化,这是缠论体系中最重要的概念演化之一。演化动机:解决"古怪线段"问题。

### 第62课 (2007-06-30) — 旧笔首次定义

> "两个相邻的顶和底之间构成一笔,所谓笔,就是顶和底之间的其他波动,都可以忽略不算,但注意,一定是相邻的顶和底,隔了几个就不是了。"(L26)
>
> "在实际分析中,都必须要求**顶和底之间都至少有一K线**当成一笔的最基本要求。"(L26)

- **旧笔标准**:顶分型与底分型之间至少有一根独立K线(即包含处理后不属于顶底分型)
- 这是**包含处理后(merged)序列上的计数**
- 明确了"相邻"概念:顶底必须交替
- 确立了包含关系的处理法则(L28)

### 第65课 (2007-07-16) — 形式化补充

> "先顶后底,构成向下一笔;先底后顶,构成向上一笔。而所有的图形,都可以唯一地分解为上下交替的笔的连接。"(L40)

- 强化了笔的唯一性:顶底严格交替
- 笔的两端分型作为"膝盖"连接高低级别结构(L40)
- 引入了笔划分唯一性的严格证明

### 第77课 (2007-09-05) — 概念再分辨

> "当然。顶上如果还有顶,那第一个顶就不是顶。"(L261,答疑)

- 澄清了分型去重规则:同性分型保留更极端者
- **明确了方向有效性约束**:"在同一笔中,顶分型中最高那K线的区间至少要有一部分高于底分型中最低那K线的区间"(L38)——即顶不能低于底
- 这个约束后来在第78课被称为"顶高于底"硬约束

### 第78课 (2007-09-06) — 古怪线段问题暴露

> "所有古怪的线段,都是因为线段出现第一种情况的笔破坏后最终没有在该方向由该笔发展形成线段破坏所造成的,这是线段古怪的唯一原因。"(L30)

- 古怪线段现象集中暴露
- 根源:旧笔在包含处理后的间距限制下,某些短促波动不成笔,但又不能忽略,导致线段划分出现"开始点不是最高/最低点"的反常情况(L42)
- 这为新笔定义的引入埋下伏笔

### 第81课 (2007-09-18) / 忽闻台风可休市 — 新笔定义引入

> "本ID想了想,计算了一下能量力度,觉得以后可以把**笔的成立条件略微放松一下**,就是一笔必须满足以下两个条件:"(L110)
>
> "1、顶分型与底分型经过包含处理后,不允许共用K线,也就是不能有一K线分别属于顶分型与底分型,这条件和原来是一样的,这一点绝对不能放松,因为这样,才能保证足够的能量力度;"
>
> "2、在满足1的前提下,顶分型中最高K线和底分型的最低K线之间(不包括这两K线),**不考虑包含关系**,至少有3根(包括3根)以上K线。"(L110)

- **新笔核心变化**:间距计数基准从"包含处理后(merged)"改为"原始K线(raw)"
- **"不考虑包含关系"**明确写在原文中,不是模糊表述
- 条件放松:merged序列可能只有2根间隔,但raw序列有3根即可成笔
- **效果**:"象今天绿箭头所指的地方,就是一笔了,相应那三笔下来就构成一段了,整个划分就不会出现比较古怪的线段。"(L110)
- 缠师在同一段中强调:"本ID刚计算过,也不会影响整个线段的动力学能量"

### 第81课后续答疑 (2007-09-19)

> "那主要是为了不同软件间可以减少不同,因为,K线的个数是肯定基本一样的,这样,就不会因为一些微小的差别导致不同的结果。而且,分别起来更简单,所以,可以用新标准。"(L160)

- 新笔定义的实用动机:消除软件数据差异的影响
- "可以用新标准"——缠师明确授权

### 谱系小结

| 阶段 | 课号 | 日期 | 性质 | 核心变化 |
|------|------|------|------|----------|
| 旧笔定义 | 第62课 | 2007-06-30 | 首次定义 | merged序列上至少1根间隔K线 |
| 形式化 | 第65课 | 2007-07-16 | 严格化 | 唯一性证明,顶底交替 |
| 约束补充 | 第77课 | 2007-09-05 | 再分辨 | 顶高于底硬约束 |
| 问题暴露 | 第78课 | 2007-09-06 | 问题诊断 | 古怪线段归因于笔定义的不足 |
| **新笔定义** | **第81课** | **2007-09-18** | **概念升级** | **raw序列上至少3根K线,消除古怪线段** |
| 确认授权 | 第81课答疑 | 2007-09-19 | 确认 | "可以用新标准" |

**演化链总结**:
- **问题链**:旧笔(merged计数) → 某些短促波动不成笔 → 线段划分出现古怪情况(开始点非极值) → 违反直觉与操作性
- **解决链**:新笔(raw计数) → 放松间距要求 → 短促波动成笔 → 古怪线段消除 → 能量力度不变,可操作性增强

**谱系地位**:新笔定义是缠师在实战中发现问题、理论推演、形式化修正的完整闭环案例,体现了缠论"知行合一、问题驱动"的方法论特质。

---

## 定义

笔是两个**相邻的、异性的**分型之间的连接。

- **上升笔**: 底分型 → 顶分型（方向 up）
- **下降笔**: 顶分型 → 底分型（方向 down）

笔是走势的最小可编码单元。所有高级别结构（线段、中枢、走势类型）以笔为原子部件。

## 成立条件

### 条件1：异性分型

起止必须是一顶一底（或一底一顶）。同性分型之间不成笔。

### 条件2：间距

**旧笔（mode="wide"）**：在**包含处理后**（merged）序列上计数。顶底分型之间至少有一根 merged bar 不属于顶分型与底分型。等价于 `cand.idx - start.idx >= 4`（merged bar 间距）。

**新笔（默认，mode="new"）**：在**原始**（raw）K线上计数。原文（《忽闻台风可休市》L110）明确写"**不考虑包含关系**"。两个条件：
1. 顶底分型不共用K线（与旧笔相同）
2. 顶分型最高K线与底分型最低K线之间（不含这两根），在原始K线序列上至少有3根K线

**核心差异**：计数基准不同。包含处理压缩K线后，merged 间距可能 < 4，但原始K线间距可能 >= 3。新笔比旧笔宽松——旧笔下某些短促波动不成笔（merged 间距不足），但新笔下成笔（原始间距足够）。这减少了不合理的分型组合，从而消除古怪线段。

**实现路径**：`merge_inclusion()` 已返回 `merged_to_raw: list[tuple[int, int]]`。新笔间距 = `merged_to_raw[cand.idx][0] - merged_to_raw[start.idx][1] - 1 >= 3`。

> 口径选择是生成态矛盾。见谱系 001-degenerate-segment。

### 条件3：方向有效性

- 上升笔：终点价（顶分型极值） > 起点价（底分型极值）
- 下降笔：终点价（底分型极值） < 起点价（顶分型极值）

违反此条件的分型对不成笔。

## 划分规则（可编码）

1. 从分型序列中去重：同类相邻分型，保留更极端者（顶取更高，底取更低）
2. 强制顶底交替
3. 逐对检查：间距 + 方向有效性
4. 锁定规则：已成笔的终点不可被替换；遇同类更极端分型时，延伸当前笔（更新终点），不断开新笔
5. 最后一笔标记为未确认（confirmed=False），延伸中

## 当前实现

- **文件**: `src/newchan/a_stroke.py :: strokes_from_fractals`
- **口径**: 新笔（mode="new"，raw K线计数，间距≥3 raw bars）
- **数据结构**: `Stroke` dataclass（frozen, slots）
- **字段**: i0, i1, direction, high, low, p0, p1, confirmed

## 边界条件

- 当间距恰好等于阈值时（边界上），成笔。`gap >= min_gap` 是闭区间。
- 两个分型共用K线但间距不足时，不成笔。
- 同类分型连续出现时，只保留最极端的一个，其余被丢弃。
- 最后一笔始终为 confirmed=False，直到下一笔生成后才结算。

## 未结算问题

1. ~~**旧笔 vs 新笔**~~ **已验证**：旧笔（7笔序列含回头波动）→ v1 产出退化段（up: ep1=99 < ep0=100）。精简笔序列（模拟新笔过滤）→ v1 正常（up: ep1=115 > ep0=100）。**新笔消除退化段的假说成立。** mode="new" 已实现（谱系 001 待正式结算）。
2. ~~**新笔的"3根K线"是否考虑包含关系**~~ **已澄清**：原文明确写"不考虑包含关系"，即在原始K线上计数。不再是争议项。
3. **wide vs strict 模式的语义**：wide（gap>=4 merged）= 旧笔。strict（gap>=5 merged）无原文对应，可能是经验值，待确认是否保留。
4. ~~**何时切换默认值**~~ **已完成**：mode="new" 已设为 `strokes_from_fractals` 和 `BiEngine` 的默认值。全量测试 1435 通过。

## 已完成验证（v1.3）

- [x] 单元测试：TestNewBiMode 6个用例（strokes_from_fractals 级别）
- [x] 全管线集成测试：13个用例（inclusion→fractals→strokes + BiEngine）
  - 包含压缩效应验证（新笔≥旧笔笔数）
  - 新笔价格有效性、方向交替、首尾相连
  - 新笔+线段退化段减少（001假说核心）
  - BiEngine mode="new" 端到端运行
  - 边界条件（无包含、空输入、单bar）
- [x] BiEngine merged_to_raw 传参缺陷修复
- [x] 真实市场数据 E2E 验证（DataBento AAPL 1分钟，1950 RTH bars，177笔方向交替100%✅）

## 谱系引用

- `001-degenerate-segment`：退化段问题源于旧笔口径选择（✅ 已结算，真实数据退化段率=0%）
- `002-source-incompleteness`：笔定义的完整原文依据已补录（✅ 已结算）
- `003-segment-concept-separation`：线段两口径差异，v0降级为参考实现（✅ 条件结算）
