# 分型（Fenxing / Fractal）

**版本**: v1.0
**状态**: 已结算
**最后更新**: 2026-02-15
**变更**:
- v1.0 初版
- v1.0.1 增加原文谱系
**原文依据**: 编纂版 §五；博文第62课

---

## 原文谱系

分型概念在缠师108课中的演化：

### 第19课 (2006-12-27) — 概念影子期

> "企图用些单纯的指标、波段、波浪、**分型**、周期等等预测、把握，只可能错陋百出。"

- **首次提及**："分型"一词出现，但作为批判对象
- 缠师将分型与波浪理论、江恩理论等并列为"把复杂走势标准化成固定模式"的工具
- **未定义**：此时分型概念尚未被纳入缠论体系
- **性质**：否定性提及，暗示后续将有不同于传统分型的定义

### 第62课 (2007-06-30) — 创世定义（关键课）

> "第二K线高点是相邻三K线高点中最高的，而低点也是相邻三K线低点中最高的，本ID给一个定义叫**顶分型**；底分型，第二K线低点是相邻三K线低点中最低的，而高点也是相邻三K线高点中最低的。"

- **双条件形式化**：high和low必须同时满足极值条件
- **三K线结构**：分型由三根相邻K线构成，中间K线为极值点
- **包含处理前置**："相邻"是指**包含处理后**的相邻
- **顶和底**：顶分型的顶 = K[i].high，底分型的底 = K[i].low
- **笔的基础**：顶底之间至少有一根独立K线才构成笔
- **直觉描述**："看图就明白"——假设读者能直观理解

### 第65课 (2007-07-16) — 几何化严格（关键课）

> "如果真明白了前面的，这课就不必再说了。本ID反复强调，本ID理论的关键是一套几何化的思维，因此，你需要从最基本的定义出发。"

- **包含处理形式化**：引入 `[di, gi]` 区间记号
- **方向判定公式**：向上/向下的形式化定义（见包含处理谱系）
- **当下性宣言**：
  > "分型是唯一的，客观的，不以任何人的意志为转移的，唯一的要求就是被分析的K线已经走出来。"
- **分型的作用**：构成笔的端点（顶底相邻构成笔）
- **结合律约束**：相邻分型之间不能共用K线

### 第77课 (2007-09-05) — 概念再分辨

> "分型就不用再说了，按定义，只要把包含关系搞清楚，相信连孔男人都应该能描红一番。如果没有包含关系，3个K线就可以决定一个分型，但注意，任何相邻的分型之间必须满足结合律。"

- **笔中顶底的合理性约束**：
  > "在同一笔中，顶分型中最高那K线的区间至少要有一部分高于底分型中最低那K线的区间，如果这条都不满足，也就是顶都在低（底）的范围内或顶比底还低，这显然是不可接受的。"
- **数学证明**：给出笔划分唯一性的形式化证明
- **操作步骤**：
  1. 确定所有标准分型
  2. 同性质分型去重（前高后低保留后，前低后高保留后）
  3. 相邻异性分型成笔，相邻同性取首尾

### 第82课 (2007-09-24) — 心理因素深化

> "一个顶分型之所以成立，是卖的分力最终战胜了买的分力，而其中，买的分力有三次的努力，而卖的分力，有三次的阻击。"

- **三次博弈结构**：分型的形成过程如同中枢，经历"一而再、再而三、三而竭"
- **分型力度分析**：
  - **弱分型（中继型）**：第一根长阳，第二三根小阴阳 → 可能只是小级别中枢上移
  - **强分型**：第二根长阴上影，第三根跌破第一根K线的底且不能高收到一半之上 → 极可能延续成笔
- **包含关系的市场含义**：犹豫、不确定、观望（与第82课包含处理谱系呼应）
- **中继分型判别**：观察对应小级别中枢是否出现第三类买卖点

### 谱系小结

| 阶段 | 课号 | 日期 | 性质 |
|------|------|------|------|
| 影子期 | 19 | 2006-12-27 | 批判传统分型，暗示新定义将至 |
| 创世定义 | 62 | 2007-06-30 | 双条件形式化，三K线结构，奠定基础 |
| 几何严格 | 65 | 2007-07-16 | 唯一性宣言，包含处理前置，结合律约束 |
| 再分辨 | 77 | 2007-09-05 | 笔中顶底合理性约束，操作步骤巩固 |
| 心理深化 | 82 | 2007-09-24 | 三次博弈机制，分型力度分类，中继型判别 |

**演化特征**：
- 从直觉描述 → 几何化 → 数学证明 → 市场心理，层层深入
- 双条件定义从第62课起就是完整的，后续是**强化**而非修正
- 第82课的分型力度分析是最实战的补充，但依然建立在62课的双条件基础上

---

## 定义

分型是包含处理后K线序列上的局部极值结构，由三根相邻K线构成。

### 顶分型（双条件）

三根相邻K线 K[i-1], K[i], K[i+1] 中，第二根 K[i] 同时满足：
- K[i].high > K[i-1].high **且** K[i].high > K[i+1].high
- K[i].low > K[i-1].low **且** K[i].low > K[i+1].low

极值价 = K[i].high

### 底分型（双条件）

三根相邻K线 K[i-1], K[i], K[i+1] 中，第二根 K[i] 同时满足：
- K[i].low < K[i-1].low **且** K[i].low < K[i+1].low
- K[i].high < K[i-1].high **且** K[i].high < K[i+1].high

极值价 = K[i].low

### 为什么是双条件

只满足 high 条件但 low 不满足（或反之）不构成分型。这不是"加强版"——这是定义本身。包含处理保证了相邻K线不存在包含关系，所以双条件在包含处理后的序列上是自然的。

## 前置条件

分型**必须**在包含处理后的K线序列（MergedBar）上判定。原始K线可能存在包含关系，在原始序列上判定分型是错误的。

## 基本结论

- 没有顶分型 → 没有顶 → 没有下降笔的起点
- 没有底分型 → 没有底 → 没有上升笔的起点
- 首尾K线不可能是分型（需要左右邻居）
- 至少需要3根MergedBar才可能出现分型
- 严格大于（不含等于）：包含处理后理论上不会出现等值，但若出现，不构成分型

## 当前实现

- **文件**: `src/newchan/a_fractal.py :: fractals_from_merged`
- **数据结构**: `Fractal` dataclass（frozen, slots）
- **字段**: idx（中心bar的iloc位置）, kind（top/bottom）, price（极值价）
- **对齐状态**: 实现与定义完全对齐，无口径分歧

## 边界条件

- 恰好等值时不成分型（严格不等式）
- 只有3根bar的序列最多产出1个分型（位于 idx=1）
- 分型识别不做去重/过滤——留给笔构造步骤

## 接口缺口（影响新笔实现）

Fractal 当前只存储 `idx`（中心bar位置）和 `price`（极值价）。不存储组成分型的三根bar各自的位置信息。

新笔间距定义需要的是"顶分型最高K线的位置"和"底分型最低K线的位置"。对于双条件分型：
- **顶分型最高K线** = 中心bar K[idx]（因为 K[idx].high 是三者最高）→ 位置就是 idx
- **底分型最低K线** = 中心bar K[idx]（因为 K[idx].low 是三者最低）→ 位置就是 idx

所以在双条件分型下，极值K线就是中心bar。**新笔间距可以直接用 `idx` 计算，不需要额外字段。**

但需要注意：新笔测量的是"不含这两根K线"之间的bar数，即 `cand.idx - start.idx - 1 >= 3`，等价于 `cand.idx - start.idx >= 4`。

> 这意味着：如果双条件分型成立，**新笔和旧笔的间距阈值可能是相同的（gap >= 4）**，差异只在测量基准的语义而非数值。这需要实证验证。

## 谱系引用

- 无直接关联的生成态矛盾
- 间接关联 001：分型定义影响笔定义，笔定义影响退化段

## 影响声明

分型是整个系统的最底层概念（K线之上第一层）。分型定义变更会级联影响笔、线段、中枢、走势类型。当前定义已结算——双条件无争议，代码对齐。
