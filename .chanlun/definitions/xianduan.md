# 线段（Xianduan / Segment）

**版本**: v1.0.1
**状态**: 生成态
**最后更新**: 2026-02-15
**变更**:
- v1.0 初版
- v1.0.1 增加原文谱系
**原文依据**: 编纂版 §七；博文第62、65、67、71、77、78课
**概念分离**: 谱系 003 — 本概念已正式分离为两个口径

---

## 原文谱系

线段概念在缠师108课中的演化链（最长、最复杂）：

### 第62课 (2007-06-30) — 直觉阶段

> "而所谓的线段，就是至少由三笔组成。"

- **首次引入**："至少三笔"
- **笔破坏直觉**：图9展示"线段破坏"（两线段组合的一种形态）
- **无形式化定义**：没有给出如何判断线段被破坏的明确标准
- **性质**：操作性描述，依赖"看图就知道"

### 第65课 (2007-07-16) — 笔破坏定义（关键转折）

> "对于从向上一笔开始的，其中的分型构成这样的序列：d1g1d2g2d3g3…dngn（其中di代表第i个底，gi代表第i个顶）。如果找到i和j，j>=i+2,使得dj<=gi,那么称向上线段被笔破坏。"

> **缠中说禅线段分解定理**：线段被破坏，当且仅当至少被有重叠部分的连续三笔的其中一笔破坏。而只要构成有重叠部分的前三笔，那么必然会形成一线段，换言之，线段破坏的充要条件，就是被另一个线段破坏。

- **笔破坏形式化**：dj <= gi（向上线段）、gj >= di（向下线段）
- **线段分解定理**：被笔破坏 ↔ 被线段破坏（充要条件）
- **前三笔重叠**：首次明确强调"线段的前三笔，必须有重叠的部分"
- **等价性声明**：旧线段终结 = 新线段形成
- **唯一性**："所有分析的答案，只和你看的走势品种与级别图有关，在这客观的观照物与显微镜倍数确定的情况下，任何的分析都是唯一的，客观的，不以任何人的意志为转移的。"

### 第67课 (2007-08-01) — 特征序列法（核心创新）

> "用S代表向上的笔，X代表向下的笔。那么所有的线段，无非两种：一、从向上笔开始；二、从向下笔开始。简单起见，以向上笔开始的线段为例子说划分的标准。"

> **定义**：序列X1X2…Xn成为以向上笔开始线段的特征序列；序列S1S2…Sn成为以向下笔开始线段的特征序列。

**两种情况的引入**（线段划分的完整标准）：

**第一种情况**（无缺口）：
> "特征序列的顶分型中，第一和第二元素间不存在特征序列的缺口，那么该线段在该顶分型的高点处结束，该高点是该线段的终点"

**第二种情况**（有缺口）：
> "特征序列的顶分型中，第一和第二元素间存在特征序列的缺口，如果从该分型最高点开始的向下一笔开始的序列的特征序列出现底分型，那么该线段在该顶分型的高点处结束，该高点是该线段的终点"

- **特征序列**：向上段取向下笔（X序列），向下段取向上笔（S序列）
- **标准特征序列**：对特征序列做包含处理后的序列
- **分型判断**：向上段只看特征序列的顶分型，向下段只看底分型
- **缺口概念**：特征序列两相邻元素间没有重合区间
- **第二种情况简化**："在第二种情况中的第二特征序列判断中，就不再分第一、二种情况了"（避免递归麻烦）
- **唯一性宣言**："按照这个划分，一切同一级别图上的走势都可以唯一地划分为线段的连接"

### 第71课 (2007-08-16) — 包含关系作用域（再分辨）

> "特征序列的元素要探讨包含关系，首先必须是同一特征序列的元素，这在理论上十分明确的。"

> "就是最早破坏那笔就是转折点下来的第一笔，这种情况下，这一笔，如果后面延伸出成为线段的走势，那么这一笔就属于中间地带，既不能说是前面一段的特征序列，更不能说是后一段的特征序列，在这里情况下，即使出现似乎有特征序列的包含关系的走势，也不能算"

- **包含关系约束**：特征序列元素的包含处理，前提是元素都在**同一特征序列**里
- **转折点两边不能包含**：转折点前后两元素不存在包含关系（不同性质）
- **转折点后可以包含**：转折点后的分型元素可以应用包含关系（同一性质）
- **第三笔完全在第一笔范围内**：两种最后结果——要么旧段延续，要么新段成立

### 第77课 (2007-09-05) — 线段方向与奇数性

> "线段和笔，都是有方向的，从顶开始的笔一定结束在底，同样，以向上笔开始的线段一定结束于向上笔，不可能一个线段，开始是向上笔，结束于一个向下笔。"

> "线段至少有三笔，但并不是连续的三笔就一定构成线段，这三笔必须有重叠的部分。"

> "线段中包含笔的数目，都是单数的。"

- **方向一致性**：线段开始笔和结束笔方向相同
- **端点性质**：不能从底到底或从顶到顶
- **奇数性**：线段的笔数一定是单数
- **前三笔重叠必须性**：再次强调
- **80-83划分问题**：第一笔笔破坏后接一符合线段标准的走势A但未创新低，反弹把走势A线段破坏后转头创新低 → 把笔破坏、走势A、反弹合成一个线段

### 第78课 (2007-09-06) — 古怪线段（最后补全）

> "在实际划分中，会碰到一些古怪的线段。其实，所谓的古怪，是一点都不古怪，只是一般人心里有一个印象，觉得线段都是一波比一波高或低，很简单那种，其实，线段完全不必要这样。"

> "所有古怪的线段，都是因为线段出现第一种情况的笔破坏后最终没有在该方向由该笔发展形成线段破坏所造成的，这是线段古怪的唯一原因。"

> "注意，这里有一个细节必须注意，线段最终肯定都会被线段破坏，但线段出现笔破坏后最终并不一定在该方向由该笔发展形成线段破坏。"

> "同样，正如同一笔不可能出现顶低于底的情况，同一线段中，两端的一顶一底，顶肯定要高于底，如果你划出一个不符合这基本要求的线段，那肯定是划错了。"

- **古怪线段的唯一原因**：第一种情况的笔破坏后最终没有在该方向由该笔发展形成线段破坏
- **笔破坏 ≠ 线段破坏**：笔破坏只是必要条件，不是充分条件
- **硬约束（第78课核心）**："顶肯定要高于底"——这是定义的一部分，不是后置过滤
- **向上破坏笔完成后接向下笔**：这个向下笔如果没破该向上笔的底 → 向上笔可延伸为线段 → 前线段B被破坏
- **向上破坏笔完成后接向下笔**：这个向下笔如果破了该向上笔的底 → 原线段B继续延续 → 可能出现段点不是最高点的情况
- **第二种情况包含处理的严格性**："对于第二种情况的第二特征序列的分型判断，必须严格按照包含关系的处理来，这里不存在第一种情况中的假设分界点两边不能进行包含关系处理的要求。"
- **标准化处理**：把最高低点不在端点的线段标准化为最高低点都在端点，简化后续中枢分析

### 谱系小结

| 阶段 | 课号 | 日期 | 性质 |
|------|------|------|------|
| 直觉阶段 | 62 | 2007-06-30 | 至少三笔，看图知道线段 |
| 笔破坏定义 | 65 | 2007-07-16 | dj<=gi 形式化，线段分解定理 |
| 特征序列法 | 67 | 2007-08-01 | 两种情况完整定义，核心创新 |
| 包含关系作用域 | 71 | 2007-08-16 | 限制特征序列包含处理的前提 |
| 方向与奇数性 | 77 | 2007-09-05 | 线段方向一致性、笔数奇数 |
| 古怪线段 | 78 | 2007-09-06 | 第一种情况笔破坏未发展成线段破坏 |

**演化特点**：
- 从直觉 → 笔破坏定义 → 特征序列法，是**概念精确化**的过程
- 第67课引入特征序列法是最大跳跃（两种情况的引入）
- 第71课对特征序列包含关系的作用域限制是理解古怪线段的关键
- 第78课的古怪线段和"顶高于底"硬约束是理解线段概念的最后一块拼图
- **线段概念的完整定义需要62→65→67→71→78五课联合阅读**

---

## 定义

线段是由**至少三笔**组成的结构，且前三笔必须有重叠部分。

### 线段划分定理

线段被终结，当且仅当至少被"有重叠部分的连续三笔"中的某一笔终结。等价表述：**旧线段终结 = 新线段形成**。

### 方向与奇数性

- 方向与起始笔一致（向上笔开始 = 向上线段）
- 线段的笔数一定是奇数

### 硬约束（第78课）

> "一个线段，两端的一顶一底，顶肯定要高于底"

违反此条件的线段划分是错误的。这是定义的一部分，不是后置过滤。

## 口径 A：三笔重叠线段（v0）

**定义**: 连续三笔 price range 有交集即成段。

**规则**:
- `max(lows of 3 strokes) < min(highs of 3 strokes)` → 重叠成立
- 贪心推进：成段后跳两笔继续扫描
- 方向 = 第一笔方向

**实现**: `src/newchan/a_segment_v0.py :: segments_from_strokes_v0`

**原文对应**: 对 §5.1 "至少三笔 + 前三笔有重叠" 的直接实现

**特征**: 无特征序列分析，无分型验证，无结算锚。简单但不完整——没有处理"新线段形成才终结旧线段"的递归逻辑。

## 口径 B：特征序列线段（v1）

**定义**: 反向笔组成特征序列 → 特征序列做包含处理 → 标准特征序列出现分型 → 旧段终结、新段生成。

**规则**（第67课完整定义）:
1. 构造特征序列：向上线段取反向笔（X序列），向下线段取反向笔（S序列）
2. 特征序列元素当K线做包含处理 → 标准特征序列
3. 标准特征序列上找分型：向上线段找顶分型，向下线段找底分型
4. 分型出现 → 两种情况：
   - **第一种**（无缺口）：分型第1、2元素间无缺口 → 笔破坏，需发展为线段破坏才终结
   - **第二种**（有缺口）：分型第1、2元素间有缺口 → 直接线段破坏
5. 结算锚验证：新段前三笔必须重叠

**实现**: `src/newchan/a_segment_v1.py :: segments_from_strokes_v1`

**原文对应**: §5.3-5.5 特征序列法（第67课）+ §5.6 古怪线段处理（第78课）

**特征**: 有 `_FeatureSeqState` 状态机，有 `BreakEvidence` 断段证据，有结算锚。

## 共享数据结构

两个口径共用 `Segment` dataclass（定义在 `a_segment_v0.py`）:
- `s0, s1`: stroke index 范围
- `i0, i1`: merged bar index 范围
- `direction`: up/down
- `ep0_*, ep1_*`: 端点信息（i, price, type）
- `kind`: settled/candidate（v1 使用，v0 默认 settled）
- `break_evidence`: 断段证据（v1 写入，v0 为 None）
- `confirmed`: 最后一段 False，其余 True

## 边界条件

- 只有两笔：不成段（最少三笔）
- 连续三笔无重叠：不成段
- 偶数笔的结构不是线段
- v1 的第一种情况（无缺口）：笔破坏但没发展为线段破坏 → 不终结旧段（古怪线段的根源）

## 未结算问题

1. **v0 和 v1 的输出差异多大？** 需要在相同数据上实证对比。（谱系 003）
2. **退化段归因于口径还是笔？** 如果新笔消除退化段，则两口径在新笔下可能收敛。（谱系 001 + 003）
3. **v0 是否应该保留？** v0 是简化版，可能作为快速估算保留，但不能作为正式线段划分。待验证后决定。
4. **第一种情况的处理**：原文说笔破坏需发展为线段破坏才终结。v1 的 `_FeatureSeqState` 是否正确实现了这个逻辑？需要审计。

## 谱系引用

- `001-degenerate-segment`：退化段问题——direction=up 但 ep1_price < ep0_price
- `003-segment-concept-separation`：线段两口径的正式分离记录

## 影响声明

线段是笔之上、中枢之下的结构。线段定义变更影响：中枢识别（中枢由线段构成）、走势类型划分、买卖点判定。当前两口径并行，下游模块需指明使用哪个口径。
