# 线段（Xianduan / Segment）

**版本**: v1.0
**状态**: 生成态
**最后更新**: 2026-02-15
**原文依据**: 编纂版 §七；博文第67、71、77、78课
**概念分离**: 谱系 003 — 本概念已正式分离为两个口径

---

## 定义

线段是由**至少三笔**组成的结构，且前三笔必须有重叠部分。

### 线段划分定理

线段被终结，当且仅当至少被"有重叠部分的连续三笔"中的某一笔终结。等价表述：**旧线段终结 = 新线段形成**。

### 方向与奇数性

- 方向与起始笔一致（向上笔开始 = 向上线段）
- 线段的笔数一定是奇数

### 硬约束（第78课）

> "一个线段，两端的一顶一底，顶肯定要高于底"

违反此条件的线段划分是错误的。这是定义的一部分，不是后置过滤。

## 口径 A：三笔重叠线段（v0）

**定义**: 连续三笔 price range 有交集即成段。

**规则**:
- `max(lows of 3 strokes) < min(highs of 3 strokes)` → 重叠成立
- 贪心推进：成段后跳两笔继续扫描
- 方向 = 第一笔方向

**实现**: `src/newchan/a_segment_v0.py :: segments_from_strokes_v0`

**原文对应**: 对 §5.1 "至少三笔 + 前三笔有重叠" 的直接实现

**特征**: 无特征序列分析，无分型验证，无结算锚。简单但不完整——没有处理"新线段形成才终结旧线段"的递归逻辑。

## 口径 B：特征序列线段（v1）

**定义**: 反向笔组成特征序列 → 特征序列做包含处理 → 标准特征序列出现分型 → 旧段终结、新段生成。

**规则**（第67课完整定义）:
1. 构造特征序列：向上线段取反向笔（X序列），向下线段取反向笔（S序列）
2. 特征序列元素当K线做包含处理 → 标准特征序列
3. 标准特征序列上找分型：向上线段找顶分型，向下线段找底分型
4. 分型出现 → 两种情况：
   - **第一种**（无缺口）：分型第1、2元素间无缺口 → 笔破坏，需发展为线段破坏才终结
   - **第二种**（有缺口）：分型第1、2元素间有缺口 → 直接线段破坏
5. 结算锚验证：新段前三笔必须重叠

**实现**: `src/newchan/a_segment_v1.py :: segments_from_strokes_v1`

**原文对应**: §5.3-5.5 特征序列法（第67课）+ §5.6 古怪线段处理（第78课）

**特征**: 有 `_FeatureSeqState` 状态机，有 `BreakEvidence` 断段证据，有结算锚。

## 共享数据结构

两个口径共用 `Segment` dataclass（定义在 `a_segment_v0.py`）:
- `s0, s1`: stroke index 范围
- `i0, i1`: merged bar index 范围
- `direction`: up/down
- `ep0_*, ep1_*`: 端点信息（i, price, type）
- `kind`: settled/candidate（v1 使用，v0 默认 settled）
- `break_evidence`: 断段证据（v1 写入，v0 为 None）
- `confirmed`: 最后一段 False，其余 True

## 边界条件

- 只有两笔：不成段（最少三笔）
- 连续三笔无重叠：不成段
- 偶数笔的结构不是线段
- v1 的第一种情况（无缺口）：笔破坏但没发展为线段破坏 → 不终结旧段（古怪线段的根源）

## 未结算问题

1. **v0 和 v1 的输出差异多大？** 需要在相同数据上实证对比。（谱系 003）
2. **退化段归因于口径还是笔？** 如果新笔消除退化段，则两口径在新笔下可能收敛。（谱系 001 + 003）
3. **v0 是否应该保留？** v0 是简化版，可能作为快速估算保留，但不能作为正式线段划分。待验证后决定。
4. **第一种情况的处理**：原文说笔破坏需发展为线段破坏才终结。v1 的 `_FeatureSeqState` 是否正确实现了这个逻辑？需要审计。

## 谱系引用

- `001-degenerate-segment`：退化段问题——direction=up 但 ep1_price < ep0_price
- `003-segment-concept-separation`：线段两口径的正式分离记录

## 影响声明

线段是笔之上、中枢之下的结构。线段定义变更影响：中枢识别（中枢由线段构成）、走势类型划分、买卖点判定。当前两口径并行，下游模块需指明使用哪个口径。
