# dispatch-spec.yaml
# 声明式工位分派规范
#
# 设计原则（033号谱系）：
#   Lead 的路由自由度通过正面规范消除，而非通过约束堵漏。
#   Lead 是 spec 解释器，不是决策者。
#   偏离 spec = 实现错误（可判定），不是设计缺陷（不可判定）。
#
# 修改路径：/ritual 仪式门控（与 definitions 同级）
# 修改提案者：meta-observer
# 版本：v1.2

version: "1.2"
provenance: "[新缠论]"
genealogy_ref: "033-declarative-dispatch-spec"

# --- G10: structural_stations 增加 tools_required 字段 ---
structural_stations:
  - name: genealogist
    agent: ".claude/agents/genealogist.md"
    purpose: "谱系写入、张力检查、回溯扫描、结晶检测与执行、pattern-buffer 扫描（051号 Pull 模型）"
    spawn_phase: "post-definition-load"
    mandatory: true
    can_be_skipped: false
    tools_required: ["Read", "Write", "Grep", "Glob", "Task", "TaskCreate", "TaskUpdate", "TaskList", "TaskGet", "SendMessage"]

  - name: quality-guard
    agent: ".claude/agents/quality-guard.md"
    purpose: "结果包检查、代码违规扫描"
    spawn_phase: "post-definition-load"
    mandatory: true
    can_be_skipped: false
    tools_required: ["Read", "Write", "Grep", "Glob", "Task", "TaskCreate", "TaskUpdate", "TaskList", "TaskGet", "SendMessage"]

  - name: meta-observer
    agent: ".claude/agents/meta-observer.md"
    purpose: "二阶反馈回路、元编排进化、dispatch-spec 修改提案"
    spawn_phase: "post-definition-load"
    mandatory: true
    can_be_skipped: false
    tools_required: ["Read", "Write", "Grep", "Glob", "Task", "TaskCreate", "TaskUpdate", "TaskList", "TaskGet", "SendMessage"]

# --- G1: optional_stations（按需激活的结构工位） ---
optional_stations:
  - name: source-auditor
    agent: ".claude/agents/source-auditor.md"
    purpose: "溯源标签验证、引用准确性检查"
    activation_condition: "session 涉及外部文献引用或 PDF 加载"

  - name: topology-manager
    agent: ".claude/agents/topology-manager.md"
    purpose: "谱系拓扑分析、hub 节点监控、链路健康检查"
    activation_condition: "谱系总数 > 30 或 pending 谱系 > 5"

  - name: gemini-challenger
    agent: ".claude/agents/gemini-challenger.md"
    purpose: "异质否定源 + 编排者代理（030a/041号谱系）"
    activation_condition: "定义处于生成态且同质质询已完成 2 轮以上，或系统遇到选择/语法记录类决断"

  - name: skill-crystallizer
    agent: ".claude/agents/skill-crystallizer.md"
    purpose: "pattern-buffer 达标模式结晶为 skill（043号谱系）"
    activation_condition: "pattern-buffer 中存在 status=candidate 且 frequency >= promotion_threshold 的模式"

# --- 041: orchestrator_proxy（编排者代理） ---
orchestrator_proxy:
  enabled: true
  genealogy_ref: "041-orchestrator-proxy"
  agent: ".claude/agents/gemini-challenger.md"
  mode: "decide"
  routes:
    - type: "选择"
      action: "调用 Gemini decide()，决策直接执行"
    - type: "语法记录"
      action: "调用 Gemini decide()，辨认结果写入谱系"
  human_override: "INTERRUPT — 人类编排者可随时覆盖"
  fallback: "Gemini 不可用时，写入 pending 等待人类"

# --- 037: recursive_spawning（递归蜂群分形结构） ---
recursive_spawning:
  enabled: true
  genealogy_ref: "037-recursive-swarm-fractal"
  rules:
    - "任何 teammate 面对 ≥1 个可分解子任务时，可 spawn 子 teammates"
    - "子 teammates 加入同一 team（team_name 参数）"
    - "子 teammates 使用 bypassPermissions 模式"
    - "子 teammates 继承完整的 spawn 能力——可以继续 spawn 子子 teammates（无限递归）"
    - "递归深度无人为限制，由 topology-manager 的背驰+分型信号自然终止"
    - "G8 递归适用：任何层级的子任务都不豁免蜂群"
    - "父 teammate 对子 teammates 负路由责任（收汇报、汇总结果）"
  visibility: "所有 teammates（含任意深度的子 teammates）在同一 task list 中可见"
  cost_control: "topology-manager 监控总 teammate 数量，通过背驰+分型信号判断收缩时机（非固定阈值）"

task_stations:
  derivation: "session.interruption_points + CLAUDE.md.objectives"
  spawn_phase: "post-structural-spawn"
  rules:
    - "每个独立中断点 = 一个工位（并行默认）"
    - "有数据依赖的中断点 = 串行链"
    - "Lead 不自行执行任务，只分派和汇总"
    - "无简单任务豁免——≥1 个任务即拉蜂群（bias-single-agent-bypass）"  # G8

ceremony_sequence:
  cold_start:
    - step: "load-methodology"
      action: "读取 SKILL.md + meta-lead.md"
    - step: "load-definitions"
      action: "扫描 .chanlun/definitions/*.md"
    - step: "scan-new-skills"
      action: "扫描 .chanlun/manifest.yaml 的 skill 时间戳，加载上次 session 后新增的 skill"
      depends_on: "load-definitions"
      genealogy_ref: "051-runtime-connection-design"
    - step: "load-genealogy"
      action: "扫描 .chanlun/genealogy/{pending,settled}/"
    - step: "load-objectives"
      action: "读取 CLAUDE.md 当前阶段目标"
    - step: "status-report"
      action: "输出定义基底、谱系状态、目标"
    - step: "spawn-structural"
      action: "按 structural_stations 列表 spawn 全部结构工位"
      validation: "spawn 数量 == structural_stations.length"
    - step: "definition-base-check"
      action: "每个 structural station spawn 后，复述本次任务涉及的关键定义，Lead 对照 definitions/ 检查"
      depends_on: "spawn-structural"
      genealogy_ref: "040-negation-topology-formalization"
    - step: "spawn-task"
      action: "按 task_stations.rules 从中断点派生任务工位"
      depends_on: "definition-base-check"  # G7/G9: 显式前置条件
    - step: "divine-madness"
      action: "Lead 自我权限剥夺（032号谱系）"
      depends_on: "spawn-structural, spawn-task"  # G7/G9: 依赖所有 spawn 完成
    - step: "enter-swarm-loop"
      action: "直接进入蜂群循环，不等待确认"
      depends_on: "divine-madness"

  warm_start:
    - step: "locate-session"
      action: "定位最新 .chanlun/sessions/*.md"
    - step: "load-methodology"
      action: "读取 SKILL.md + meta-lead.md"
    - step: "version-diff"
      action: "对比 session 记录 vs 当前 definitions/ 版本"
    - step: "genealogy-diff"
      action: "对比 session 记录 vs 当前 genealogy/ 状态"
    - step: "load-interruption-points"
      action: "从 session 读取中断点"
    - step: "diff-report"
      action: "输出差异报告（= ↑ + -）"
    - step: "spawn-structural"
      action: "按 structural_stations 列表 spawn 全部结构工位"
      validation: "spawn 数量 == structural_stations.length"
    - step: "definition-base-check"
      action: "每个 structural station spawn 后，复述本次任务涉及的关键定义，Lead 对照 definitions/ 检查"
      depends_on: "spawn-structural"
      genealogy_ref: "040-negation-topology-formalization"
    - step: "spawn-task"
      action: "按 task_stations.rules 从中断点派生任务工位"
      depends_on: "definition-base-check"  # G7/G9
    - step: "divine-madness"
      action: "Lead 自我权限剥夺（032号谱系）"
      depends_on: "spawn-structural, spawn-task"  # G7/G9
    - step: "enter-swarm-loop"
      action: "直接进入蜂群循环，不等待确认"
      depends_on: "divine-madness"

validation:
  post_ceremony:
    - check: "all_structural_spawned"
      condition: "所有 structural_stations 中 mandatory=true 的工位均已 spawn"
      on_fail: "阻塞——不允许进入蜂群循环"
    - check: "lead_permissions_restricted"
      condition: "settings.local.json 中 Lead 只保留 Read/Glob/Grep/Task/SendMessage/TaskList/TaskGet/TaskUpdate"
      on_fail: "阻塞——032号谱系要求"
    - check: "task_stations_derived"
      condition: "至少从中断点派生了一个任务工位（除非中断点为空）"
      on_fail: "警告——可能遗漏工作"
    # G2: crystallization_check
    - check: "crystallization_check"
      condition: "genealogist 的结晶检测已执行（扫描近期谱系的背驰+分型信号）"
      on_fail: "警告——可能遗漏结晶时机"
    # G6: 构成性矛盾记录（不修 spec，注释记录）
    # 注意：meta-observer 自身是 dispatch-spec 的修改提案者，同时也是 dispatch-spec 的执行监控者。
    # 这是构成性矛盾（020号谱系）：观察者与被观察系统不可分离。
    # 处置：接受为系统的构成性特征，meta-observer 持续监控此矛盾的表现。

  # G4: post_commit_flow 引用
  post_commit:
    ref: ".claude/skills/meta-orchestration/references/post-commit-flow.md"
    description: "commit 后执行的标准流程（session 写入、谱系更新检查）"

# G3: axis_report 模板定义
axis_report:
  template:
    sections:
      - "定义基底状态（新增/修改/删除）"
      - "谱系状态（pending 数量、近期结算、结晶信号）"
      - "蜂群工位状态（各工位进度摘要）"
      - "中断点消化进度"
      - "下一步行动建议"
    constraints:
      - "每个 section 不超过 3 行"
      - "只报告变化，不重复已知信息"
  frequency: "每蜂群循环结束"
  producer: "Lead"
  consumers: "所有工位（通过 broadcast 或 session 文件）"

# --- 043: automation（自生长回路基础设施） ---
automation:
  pattern_detection:
    enabled: true
    trigger: "session_end"
    buffer_path: ".chanlun/pattern-buffer.yaml"
    min_sequence_length: 2
    promotion_threshold: 3  # 频次达标阈值
  crystallization:
    auto_trigger: true
    require_genealogy_settlement: true
  manifest:
    path: ".chanlun/manifest.yaml"
    auto_register: true

# --- 049: orchestration_protocol（事件路由表） ---
orchestration_protocol:
  version: "1.0"
  genealogy_ref: "049-orchestration-routing-table"
  routes:
    - event: file_change
      pattern: "spec/theorems/*"
      target: gemini_math_verify
      action: "gemini_challenger verify --context-file {file}"
      priority: high

    - event: file_change
      pattern: "docs/chan_spec.md"
      target: genealogist
      action: "lineage_consistency_check"
      priority: high

    - event: file_create
      pattern: "**/*"
      target: manifest_guard
      action: "check_manifest_registration"
      priority: high

    - event: annotation
      pattern: "@proof-required"
      target: gemini_math_prove
      action: "gemini_challenger challenge --math"
      priority: low_async

    - event: task_queue
      condition: "independent_tasks >= 2"
      target: swarm_manager
      action: "spawn_recursive_swarm"
      priority: high

    - event: session_start
      target: meta_lead
      action: "ceremony"
      priority: critical

    - event: session_end
      target: pattern_detector
      action: "post_session_pattern_detect"
      priority: low_async

    - event: tool_error
      pattern: "gemini_api_*"
      target: system
      action: "fallback_local_rules"
      priority: critical

    - event: build_failure
      condition: "consecutive_failures >= 3"
      target: build_resolver
      action: "auto_fix_build"
      priority: medium
