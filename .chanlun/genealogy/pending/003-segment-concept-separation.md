# 概念分离 003：线段的两个口径

**状态**: 生成态
**创建时间**: 2026-02-15
**类型**: 概念分离（自治行为）
**域**: 线段（Segment）
**来源**: 编排者指出"分离首先在线段两个口径上"，且"概念分离也需要被谱系化"

---

## 分离描述

"线段"在本仓库中存在两个独立口径，已实现为两个并行模块。本记录将其正式分离为两个命名概念。

## 分离前

"线段"作为单一概念，但有两种实现：
- `a_segment_v0.py` — 称为"v0"
- `a_segment_v1.py` — 称为"v1"

两者共用同一个 `Segment` 数据类（定义在 `a_segment_v0.py`），没有形式化的概念区分。

## 分离后的两个概念

### 概念 A：三笔重叠线段（v0）

- **文件**: `a_segment_v0.py :: segments_from_strokes_v0`
- **定义**: 连续三笔 price range 有交集（`overlap_low < overlap_high`）即成段
- **算法**: 贪心窗口扫描，成段后跳两笔
- **方向**: 第一笔方向
- **原文对应**: 对"至少三笔"规则的简化理解
- **特征**: 无特征序列分析，无分型验证，无结算锚

### 概念 B：特征序列线段（v1）

- **文件**: `a_segment_v1.py :: segments_from_strokes_v1`
- **定义**: 反向笔组成特征序列，特征序列出现分型则旧段终结、新段生成
- **算法**: 增量特征序列扫描 + 分型触发 + 结算锚验证（新段前三笔必须重叠）
- **方向**: 第一笔方向
- **原文对应**: §67课特征序列法
- **特征**: 有 `_FeatureSeqState` 状态机，有 `BreakEvidence` 断段证据

## 共享结构

两个口径共用 `Segment` 数据类，其中：
- `kind` 字段：`"settled"` / `"candidate"` — v1 使用，v0 默认 `"settled"`
- `break_evidence` 字段：v1 写入，v0 为 `None`
- `ep0_*` / `ep1_*` 端点字段：两者都写入，但计算方式不同

## 验证结果（2026-02-16）

### 实证数据（3类场景，合成笔序列）

| 场景 | 笔数 | v0段数 | v1段数 | v0退化 | v1退化 |
|------|------|--------|--------|--------|--------|
| overlap_6 (6笔重叠) | 6 | 2 | 1 | 0 | 0 |
| degenerate_7 (7笔回头) | 7 | 3 | 1 | 0 | 0 |
| standard_7 (7笔标准) | 7 | 3 | 1 | 0 | 0 |

### 关键发现

1. **v0 贪心切割**：每3笔重叠就成段，段数远多于 v1（比例 2-3:1）
2. **v1 等待分型**：特征序列未出现分型时不断段，单段覆盖全部笔
3. **退化段归因于笔层**：在干净笔序列上两口径都不产生退化段。退化段根因在旧笔（谱系 001），非口径差异
4. **对比测试完整**：`test_segment_v0_vs_v1_comparative.py` 10/10 通过

### 已验证项

- [x] v0 在合成数据上不产生退化段（退化段需要旧笔漏判才出现）
- [x] v1 在合成数据上不产生退化段
- [x] v0 段数 ≥ v1 段数（贪心 vs 分型，假说成立）
- [x] 退化段是笔定义导致，非口径差异（谱系 001 已证实）

### 待验证（阻塞于真实数据或代码审计）

- [ ] v1 的第一种情况（无缺口笔破坏→等待线段破坏）是否正确实现？（审计中）
- [ ] 真实市场数据上 v0/v1 差异的实际影响（阻塞于数据获取）
- [ ] v0 是否应作为正式口径保留？（需编排者决断）

## 谱系链接

- 前置：001-degenerate-segment.md（退化段问题触发了对线段口径的审视）
- 前置：002-source-incompleteness.md（§67课原文已补录，可作为验证依据）
- 后续：待实证对比后，可能结算 001
