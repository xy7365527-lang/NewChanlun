---
id: "108"
title: "背驰定义到实现的选择谱系"
status: "已结算"
type: "语法记录"
date: "2026-02-22"
depends_on: []
related: ["004", "007", "009"]
negated_by: []
negates: []
provenance: "[旧缠论:选择]"
---

# 108 — 背驰定义到实现的选择谱系

**类型**: 语法记录
**状态**: 已结算
**日期**: 2026-02-22
**域**: 背驰（Beichi / Divergence）
**溯源**: [旧缠论:选择]

---

## 目的

记录背驰概念从缠论原文定义到 `a_divergence.py` / `a_divergence_v1.py` 实现过程中做出的选择。这些选择已在代码和 `beichi.md` 中运作，但缺乏独立的谱系追踪。

---

## 选择清单

### C1: 力度度量——MACD 柱子面积作为主力度代理

**原文**：
- "C段 MACD 柱子面积 < A段面积 → 标准背驰"（第24课）
- "用MACD判断背驰…准确率也应该在90%以上。而配合上中枢，那是100%绝对的。"（第25课）

**选择**：`macd_area_for_range()` 计算指定 bar 范围内的 MACD 柱子面积之和作为力度度量。上涨看 `area_pos`（红柱），下跌看 `|area_neg|`（绿柱）。

**依据**：
- 原文明确给出 MACD 柱子面积作为标准判断方法
- MACD 是可编码的客观指标，避免主观判断
- `_compute_force()` 函数封装此逻辑

**替代方案**：
- 纯价格范围代理（`seg.high - seg.low`）→ 作为无 MACD 数据时的 fallback 保留
- 成交量力度 → 原文未作为背驰判断的主要依据，未实现

### C2: 三维背驰判断——OR 关系（已结算）

**原文（三条独立证据，均指向 OR）**：
- 第25课 L38（正文）："黄白线不能创新高，**或者**柱子的面积**或者**伸长的高度能不能突破新高" — 原文用"或者"连接三维度
- 第26课 答疑 L521："如果黄白不创新高或新低，**或**柱子面积之和小了，都是信号。**两个只要出现一个**就要注意了。如果两个都出现，那就更要注意了。" — 明确"只要出现一个"= OR 语义
- 第25课 L345（答疑）："各位一定要把MACD判断背驰的几个条件**综合**起来，不能光看柱子就完事……就是因为柱子经常无效，所以才需要综合性的背驰概念" — "综合"指多维度交叉验证（任一命中即报警），非全部条件AND

**选择（已结算）**：v1 实现三维 OR 判断：
- T5: MACD 柱子面积（`macd_area_for_range`）
- T6: DIF 峰值（`dif_peak_for_range`）
- T7: 柱子伸长高度峰值（`histogram_peak_for_range`）
- `_check_three_dim_divergence()` 组合三个维度，**任一满足即判定背驰**

**依据**：
- 第25课正文"或者"连接三维度 → OR 的直接文本证据
- 第26课答疑"两个只要出现一个" → OR 的显式确认
- 第25课答疑"综合"的语境 = 多信号综合报警（区别于单一柱子缩短），不是 AND 门控
- 反证：第25课 L16 描述的600779案例——"面积大于前面的，但这种两次冲击乖离极限而不能突破"→ 面积大但柱高不升仍判定为力度衰竭，支持 OR（面积不是必要条件）

**溯源**：[旧缠论:选择] — 原文用"或者"表述，但未以定理形式给出 OR/AND 的严格定义。"选择"是因为原文自然语言的"或者"在形式化为布尔逻辑时需要确认语义

### C3: B段穿越0轴前提检查

**原文**：
- "用MACD判断背驰的前提是…这个中枢一般会把MACD的黄白线回拉到0轴附近"（第24课）

**选择**：检查 B 段（中间中枢段）期间 MACD DIF 是否穿越 0 轴。实现为 `_b_segment_crosses_zero()`。

**依据**：
- 原文明确将"回拉0轴"作为 MACD 判断背驰的**前提条件**
- 不满足前提时，MACD 面积比较的语义基础不成立

### C4: 趋势背驰 vs 盘整背驰分离

**原文**：
- "没有趋势，就没有背驰。在盘整中是无所谓'背驰'的"（第24课）
- 但盘整中有"盘整背驰"（第24课另一段）

**选择**：
- `kind="trend"`: A+B+C 三段法，A/C 同向趋势段，B 中间中枢
- `kind="consolidation"`: 盘整中同向离开段力度比较
- 两种判断在代码中为独立函数：`_detect_trend_divergence()` 和 `_detect_consolidation_divergence()`

**依据**：
- 原文严格区分两种背驰的语义（趋势背驰必然终结趋势，盘整背驰不一定）
- 007/009号谱系确认趋势/盘整是不同实体，背驰类型也应分离

### C5: Divergence 数据结构选择

**选择**：`Divergence` 为 frozen dataclass，包含：
- `kind`: "trend" | "consolidation"
- `direction`: "top" | "bottom"（顶背驰/底背驰）
- `force_a`, `force_c`: A/C 段力度值
- `dif_peak_a`, `dif_peak_c`: DIF 峰值（T6）
- `hist_peak_a`, `hist_peak_c`: 柱子高度峰值（T7）
- `confirmed`: 背驰是否已确认

**依据**：
- 不可变数据类型（frozen=True）符合项目编码规范
- 三维力度值全部保留，供下游（买卖点）使用

### C6: v0/v1 双管线保留

**选择**：
- `a_divergence.py`（v0）：依赖 Center + TrendTypeInstance
- `a_divergence_v1.py`（v1）：依赖 Zhongshu + Move
- 两者共享 `Divergence` 输出类型

**依据**：
- v0 保留供对比和回归测试
- v1 使用新的数据管线但语义不变
- 共享输出类型确保下游（买卖点）可切换管线

---

## 六要素

### 1. 结论
背驰实现做了六项选择（C1-C6），核心选择是 MACD 面积作为力度代理 + 三维判断 + B段0轴前提。所有选择均基于原文明确指示。

### 2. 定义依据
第24课（背驰定义 + MACD方法）、第25课（MACD深化 + 三维度）、第37课（a+A+b+B+c结构）。beichi.md v1.1（已结算）。

### 3. 边界条件
- C2（三维组合方式）已结算为 OR 关系——如果未来发现原文有明确的 AND 语义证据（当前未发现），结论翻转
- C1（MACD 面积）在无 MACD 数据场景下降级为价格范围代理，精度降低
- C3（B段穿越0轴）如果原文"一般"被解读为非必要条件，则此前提检查可放宽

### 4. 下游推论
- 买卖点识别直接依赖 Divergence 输出——C2 的三维组合方式影响买卖点产出数量
- 区间套搜索（`nested_divergence_search`）在多级别上递归使用背驰检测——C1 的力度度量一致性关键

### 5. 谱系引用
- beichi.md v1.1（6/6 问题已结算）
- 004号（概念溯源框架——MACD 辅助判断的溯源标签）
- 007号（趋势独立实体——趋势背驰/盘整背驰分离的依据）
- 009号（盘整实体——盘整背驰独立语义的依据）

### 6. 影响声明
- 新增 `.chanlun/genealogy/settled/108-beichi-impl-choices.md`（本文件）
- 不改动任何代码或定义文件——本条目纯粹是已运作选择的显式记录
