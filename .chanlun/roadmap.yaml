# .chanlun/roadmap.yaml
# 业务目标队列（结构化业务目标载体）
#
# 设计原则（081号谱系）：
#   - 这是 ceremony_scan.py 的最高优先级任务来源
#   - 系统从这里读取待执行的业务目标，无需从叙述性文本猜测
#   - roadmap 为空时，且所有其他 scan_sources 也为空，才触发"干净终止"
#
# 状态值：
#   - active: 当前激活，下次 ceremony 应产生工位
#   - in_progress: 正在执行中
#   - blocked: 有外部阻塞项（填写 blocked_by）
#   - completed: 已完成
#   - deferred: 明确搁置
#
# 来源：078号 D 策略 + Gemini decide + 人类编排者确认

version: "1.4"
genealogy_ref: "081-swarm-continuity-strategy-d"

# 里程碑：定义偏序链全节点实现完毕（2026-02-21）
# baohan→fenxing→bi→xianduan→zhongshu→zoushi→beichi→maimai 全部 ✅
# level_recursion ✅ | 小转大 ✅ | 跨标的(dengjia→bijia→liuzhuan) ✅
# 1435 测试通过 | 92 谱系已结算 | 14 定义已结算

tasks:
  - id: level_recursion
    title: "级别递归概念设计 + 业务验证"
    priority: P2
    status: completed
    completed_date: "2026-02-21"
    completion_note: |
      P1-P9 全部完成，定义 v1.0 已结算。
      RecursiveLevelEngine + RecursiveStack + RecursiveOrchestrator 全部实现。
      106 测试全 GREEN。
    source: "078号D策略（第三步）：元编排v2阶段完成，转向 level_recursion"
    description: |
      设计"级别 = 递归层级（level_id）"的概念形式化。
      从 1分钟K线为底座无限向上递归构造走势类型/中枢。
      禁止用"日线/30分/5分"等时间周期替代级别定义。
    added_by: "078号Gemini decide D策略 + 081号谱系"
    added_date: "2026-02-21"

  - id: real_data_validation
    title: "真实数据端到端验证"
    priority: P1
    status: completed
    completed_date: "2026-02-21"
    completion_note: |
      test_real_data_recursive_e2e.py: 11 passed, 1 skipped。
      RecursiveOrchestrator 在 AAPL 1分钟真实数据上全链路运行无崩溃。
      递归层级、中枢价格区间、事件单调性全部验证通过。
    source: "level_recursion 完成后的自然下游——算法需要在真实市场数据上验证"
    description: |
      用真实 1 分钟 K 线数据端到端验证递归引擎：
      1. 选取代表性品种（如 ES/NQ 期货或 A 股标的）
      2. 全链路运行：K线 → 包含 → 分型 → 笔 → 线段 → 中枢 → 走势 → 递归
      3. 验证递归层级是否合理（预期 4-5 层）
      4. 检查买卖点信号质量
      5. 可视化输出（b_chart / b_plot）
    constraints:
      - "使用口径 A（纯递归），不使用 TF 口径"
      - "数据来源：databento 或本地缓存"
    added_by: "v19-swarm lead（level_recursion完成后自动派生）"
    added_date: "2026-02-21"

  - id: buysellpoint_module
    title: "三类买卖点模块实现"
    priority: P1
    status: completed
    completed_date: "2026-02-21"
    completion_note: |
      a_buysellpoint_v1.py 已实现（336行），79个测试全GREEN。
      三类买卖点全部覆盖。maimai.md 中"0%覆盖"是过期信息，已修正。
    source: "定义偏序自然派生：maimai.md 定义已结算但代码 0% 覆盖"
    description: |
      实现缠论三类买卖点识别模块（maimai.md 的代码化）：
      1. 第一类买卖点：趋势背驰 → 走势终结点（复用 Divergence(kind="trend")）
      2. 第二类买卖点：第一类后首个次级别回调/反弹结束点
      3. 第三类买卖点：中枢离开段 + 回试段 + ZG/ZD比较
      前置依赖全部就绪：背驰(beichi)、走势类型(zoushi)、中枢(zhongshu)、级别递归(level_recursion)
    constraints:
      - "严格遵循 maimai.md 定义（已结算）"
      - "买卖点判定基于递归级别（口径A），不使用时间周期"
      - "第一类买卖点 = 趋势背驰确认点（不含盘整背驰）"
      - "第三类买卖点仅限第一次离开-回试"
    definition_ref: ".chanlun/definitions/maimai.md"
    genealogy_refs:
      - "定义偏序: maimai depends_on [beichi]"
    added_by: "v19-swarm lead（real_data_validation完成后自动派生）"
    added_date: "2026-02-21"

  - id: xiaozhuan_da
    title: "小转大机制实现（跨级别联动）"
    priority: P1
    status: completed
    completed_date: "2026-02-21"
    completion_note: |
      a_xiaozhuan_da.py 已实现，11个测试全GREEN。
      beichi.md 小转大标记从 ❌ → ✅。
    source: "定义偏序派生：beichi.md 中'小转大❌未实现'，RecursiveStack就绪后可实现"
    description: |
      实现缠论"小转大"机制：
      - 小级别趋势背驰未触及大级别买卖点时，次级别回调/反弹终结走势
      - 需要 RecursiveStack 提供多级别同时在线的中枢和走势数据
      - 与第二类买卖点紧密相关（小转大 = 2B 的一种来源）
      前置依赖：RecursiveStack(✅) + BuySellPoint(✅) + Divergence(✅)
    constraints:
      - "跨级别联动必须通过 RecursiveStack，不可硬编码级别映射"
      - "小转大是走势完成的充分非必要条件（beichi #3 已结算）"
    definition_ref: ".chanlun/definitions/beichi.md"
    added_by: "v20-swarm lead（定义偏序扫描自动派生）"
    added_date: "2026-02-21"

  - id: definition_status_sync
    title: "定义文件实现状态同步"
    priority: P2
    status: completed
    completed_date: "2026-02-21"
    completion_note: |
      def-sync 工位完成：beichi/maimai/zoushi 过期标记全部修正。
    source: "多处定义文件中的'尚未实现'标记已过期，需批量更新"
    description: |
      批量更新定义文件中过期的实现状态标记：
      - maimai.md 行373: "买卖点模块（尚未实现）" → 已实现
      - beichi.md 行458/460: "买卖点/区间套（尚未创建）" → 已创建
      - zoushi.md 行347/348: "级别/区间套（尚未创建）" → 已创建
    added_by: "v20-swarm lead（定义文件扫描发现）"
    added_date: "2026-02-21"

  # ─── 第二阶段任务（Gemini decide，083号谱系，2026-02-21）─────────────────
  # 来源：系统达到里程碑后，Gemini 编排者代理基于"对象矛盾驱动"原则派生
  # 选择理由：不是阈值驱动（拒绝覆盖率/代码行数），而是已存在的概念矛盾和状态跃迁

  - id: bi_mode_new_default
    title: "笔引擎 mode='new' 切换为默认值"
    priority: P1
    status: completed
    completed_date: "2026-02-21"
    completion_note: |
      a_stroke.py + bi_engine.py 默认 mode 从 "wide" → "new"。
      bi.md #4 状态更新。全量测试 1435 passed, 0 failed。
    source: "bi.md #4：mode='new' 已可用但尚未设为默认（前置条件 real_data_validation 已满足）"
    description: |
      bi.md 第158行记录：mode="new" 已可用但尚未设为默认。
      前置条件（真实数据端到端验证）已满足（real_data_validation: completed）。

      执行步骤：
      1. 确认 BiEngine mode="new" 在 AAPL 真实数据上的表现（引用 real_data_validation 结果）
      2. 将 BiEngine 的 default mode 从 "legacy" 改为 "new"
      3. 运行全量测试（1435个），确认无回归
      4. 如有测试失败，分析是否揭示核心定义缺陷（not workaround）
      5. 更新 bi.md 状态标记
    constraints:
      - "如测试出现大面积失败且无法在不修改定义的前提下修复，停下来走矛盾上浮"
      - "不降低测试覆盖率来回避定义冲突"
    definition_ref: ".chanlun/definitions/bi.md"
    genealogy_refs:
      - "001-degenerate-segment（新旧笔对退化段的影响）"
    added_by: "083号Gemini decide（异质质询代理执行）"
    added_date: "2026-02-21"

  - id: recursion_termination_consistency
    title: "递归终止条件表述统一（dispatch-dag 内部矛盾修正）"
    priority: P1
    status: completed
    completed_date: "2026-02-21"
    completion_note: |
      recursion-term 工位完成。两种表述指不同层面（元编排递归 vs 代码递归），已澄清。
    source: "069号谱系 unresolved 项4：dispatch-dag 混用'区间套收敛'（第377行）和'背驰+分型'（第197-198行）"
    description: |
      dispatch-dag.yaml 中存在同一概念的两种表述：
      - 第197-198行（task_template）：递归终止使用"020号背驰+分型"
      - 第377行（swarm_topology）：递归终止使用"区间套收敛信号"

      这两种表述是否等价？还是指不同的终止机制？

      执行步骤：
      1. 读取 020号谱系，确认"背驰+分型"的精确定义
      2. 读取 069号谱系，确认"区间套收敛"的精确定义
      3. 判断：等价（统一表述）还是矛盾（走矛盾上浮）
      4. 如等价：选择更准确的表述，统一 dispatch-dag.yaml
      5. 如矛盾：生成谱系，上浮给编排者
      6. 更新 069号谱系 unresolved 项4 状态
    constraints:
      - "不绕过矛盾——如两种表述不可调和，必须走矛盾上浮"
      - "修改 dispatch-dag.yaml 是行动类（不携带信息差的操作），但分析表述等价性是概念类（需要质询）"
    genealogy_refs:
      - "069-recursive-topology-async-self-referential-swarm（unresolved #4）"
    added_by: "083号Gemini decide（异质质询代理执行）"
    added_date: "2026-02-21"
