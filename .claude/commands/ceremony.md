# /ceremony — 创世仪式（冷启动 / L2 热启动）

蜂群启动时执行。根据是否存在 session 文件自动选择冷启动或热启动模式。

## 用法

```
/ceremony
```

在新的蜂群会话开始时调用一次。命令自动检测模式，无需手动指定。

---

## 模式判定

执行以下检测序列，确定启动模式：

1. 扫描 `.chanlun/sessions/` 目录
2. 查找**非 precompact** 的 session 文件（排除 `*-precompact.md`）
3. 按修改时间倒序取最新的一个

| 条件 | 模式 | 说明 |
|------|------|------|
| 无 session 文件，或 `.chanlun/sessions/` 不存在 | **冷启动** | 首次使用或历史记录清空 |
| 存在非 precompact session 文件 | **热启动（L2）** | 跨会话恢复 |

---

## 冷启动（Cold Start）

无 session 文件时执行。与历史行为完全一致。

### 执行步骤

1. **加载定义** — 从知识仓库拉取所有当前定义：
   - 速查定义：`缠论知识库.md`
   - 域对象 schema：`definitions.yaml`
   - 规则规范：`docs/spec/`（segment_rules_v1.md, zhongshu_rules_v1.md, move_rules_v1.md 等）
   - 定义文件：`.chanlun/definitions/`（所有 `*.md` 文件的版本和状态）
2. **加载谱系** — 从 `.chanlun/genealogy/` 目录拉取所有谱系记录，区分生成态（`pending/`）和已结算（`settled/`）
3. **加载目标** — 从 CLAUDE.md 读取当前阶段目标和核心原则
4. **状态报告** — 输出完整仪式报告（见下方输出格式）
5. **确认** — 列出关键概念的当前理解，**等待编排者确认或校正**

### 输出格式

```markdown
## 🔵 创世仪式完成（冷启动）

### 定义基底
- 已结算定义：[N] 条
- 生成态定义：[M] 条
- [列出每条定义的名称、版本和状态]

### 谱系状态
- 生成态矛盾：[N] 个
- 已结算记录：[M] 个
- [列出每个生成态矛盾的ID和简述]

### 当前目标
[从 CLAUDE.md 读取]

### 核心原则
[列出 CLAUDE.md 中的9条核心原则摘要]

### 待确认
以上理解是否正确？如有偏差请指出。
```

---

## 热启动（Warm Start / L2 跨会话恢复）

检测到 session 文件时执行。目标：最小化重复加载，最大化恢复速度。

### 执行步骤

1. **定位 session** — 取 `.chanlun/sessions/` 中最新的非 precompact session 文件
   - 同时检查是否有比手动 session 更新的 precompact 快照，如有则合并信息
2. **加载定义基底快照** — 从 session 文件的"定义基底"表格读取上次状态
3. **版本对比** — 扫描 `.chanlun/definitions/` 中每个定义文件的当前版本，与 session 记录对比：
   - **未变更**：标记为 `=`，跳过重新验证
   - **版本升级**：标记为 `↑`，读取变更摘要
   - **新增定义**：标记为 `+`
   - **定义消失**：标记为 `-`（异常，需警告）
4. **谱系差异** — 对比当前 `.chanlun/genealogy/` 与 session 记录：
   - 新增的 pending 谱系
   - 从 pending 移入 settled 的谱系
   - 已有 pending 谱系的状态更新
5. **加载中断点** — 从 session 文件的"下次中断点"章节读取：
   - 阻塞项（需外部输入）
   - 已完成项（排除）
   - 可继续项（立即可执行的工位）
   - 最高优先缺口
   - 编排者提出的未来议题
6. **输出差异报告** — 见下方输出格式
7. **直接进入蜂群循环** — **不等待编排者确认**，立即评估可并行工位并拉起蜂群

### 版本对比算法

对于每个定义文件（`.chanlun/definitions/*.md`）：
```
当前版本 = 从文件头读取 **版本**: 字段
session版本 = 从 session 表格读取对应定义的版本列
if 当前版本 == session版本:
    标记 =（未变更）
elif 当前版本 > session版本:
    标记 ↑（升级），摘取变更记录中新增的条目
else:
    标记 ⚠（降级/异常）
```

### 输出格式

```markdown
## 🟢 热启动完成（L2 跨会话恢复）

**恢复自**: [session 文件名]
**session 日期**: [日期]
**session 类型**: [手动/precompact]

### 定义基底差异
| 定义 | session版本 | 当前版本 | 状态 | 变化 |
|------|-----------|---------|------|------|
| 包含处理 | v1.3 | v1.3 | 已结算 | = |
| 笔 | v1.3 | v1.3 | 生成态 | = |
| 线段 | v1.2 | v1.3 | 生成态 | ↑ v1.2→v1.3: [变更摘要] |
| [新增定义] | - | v1.0 | 生成态 | + 新增 |

### 谱系差异
| ID | session状态 | 当前状态 | 变化 |
|----|-----------|---------|------|
| 001 退化段 | pending | pending | = |
| 002 原文不完整 | settled | settled | = |
| 006 [新增] | - | pending | + 新增 |

### 中断点恢复
**阻塞项**（需外部输入）：
- [从 session 读取]

**可继续工位**：
- [从 session 读取，按优先级排序]

**最高优先缺口**：
- [从 session 读取]

### 蜂群评估
[评估当前可并行的独立工位数，列出本轮蜂群计划]

→ 进入蜂群循环
```

---

## 边界情况处理

### session 文件过旧
如果最新 session 文件的日期距今超过 7 天：
- 仍然执行热启动（session 文件再旧也比冷启动有信息增益）
- 在报告头部追加警告：`⚠ session 距今 [N] 天，建议先通读上次 session 确认上下文`

### precompact 比手动 session 更新
如果存在比最新手动 session 更新的 precompact 快照：
- 以手动 session 为主体（信息更丰富）
- 从 precompact 快照补充定义基底的最新状态（版本号可能更新）
- 在报告中标注：`ℹ 合并了 precompact 快照 [文件名] 的定义状态`

### 定义目录或谱系目录不存在
- 如果 `.chanlun/definitions/` 不存在：降级为冷启动
- 如果 `.chanlun/genealogy/` 不存在：创世仪式负责创建（与冷启动行为一致）

### 多个 session 文件
- 始终取最新的非 precompact 文件
- 不合并多个 session 文件（避免歧义）

---

## 注意

- 冷启动：编排者确认后质询循环才正式启动
- 热启动：**不等待确认**，差异报告输出后直接进入蜂群循环（CLAUDE.md 原则6/8/9）
- 如果 `.chanlun/genealogy/` 目录不存在，创世仪式负责创建
- 首次执行时谱系为空是正常的
- session 文件是 L1 和 L2 恢复的唯一输入，必须在每次 commit 时同步更新
- 热启动模式下，已结算定义（状态=已结算 且 版本未变更）不需要重新验证
