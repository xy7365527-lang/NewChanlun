---
name: swarm-architecture
description: 蜂群架构完整描述。创建蜂群、评估架构决策、或理解蜂群行为时激活。包含原则9-12/15-17、五约束有向依赖图、递归节点行为、结构修改模式、热启动机制。
---

## A. 架构原则

9. **热启动保障蜂群持续自动化。** 当上下文压缩（compact）发生时，通过 session 记录和 ceremony 恢复蜂群状态，确保自动化不因上下文截断而中断。蜂群是持续运行的，不是单次启动。
10. **蜂群是默认工作模式，不是可选优化。** 每个工作节点必须先评估可并行的独立工位数（≥2 即拉蜂群）。蜂群在整个会话中持续运作：完成一轮并行后，汇总结果，再评估下一轮可并行工位，循环至任务完成。单线程顺序执行只在任务间有严格依赖时才允许。
11. **上下文中的知识有走势结构。** [新缠论] 上下文窗口是系统的"当下"，容量有限——和资本在容器中的有限容量是同一结构。知识在 prompt 中的生命周期有走势结构：
    - **扩张期**：知识频繁被引用、被修改、产出新区分（活跃碰撞）
    - **收缩期**：引用时的净新区分量递减（背驰信号），不再产出新张力
    - **结晶**：收缩完成后，知识析出为外部文件（skill / 定义文件 / session），从活的上下文中释放空间
    - **重新加载**：需要时通过读取结晶物恢复（异步自指——读过去的快照，不是同步持有）

    结晶的三个维度是同一运动的不同投影：session = 时间维度结晶（过去状态快照），skill = 知识维度结晶（已稳定能力快照），definitions = 概念维度结晶（已结算定义快照）。写 skill 的 agent / ceremony / ritual 分别是各维度上的**相位转换点**。

    **推论**：元编排本身也是 skill 的集合——它和它管理的东西是同质的。编排能力分布式地结晶在 skill 中，按需加载，用完析出。没有一个特权的"最终编排者"位置凌驾于系统之上。见 020号谱系。
12. **编排者代理（Gemini Proxy）。** [新缠论] 人类编排者从同步决策者变为异步审计者。
    "选择"和"语法记录"类决断路由到 Gemini（`decide` 模式），系统据此自主推进。
    人类保留 INTERRUPT 权——可随时覆盖 Gemini 决策。被覆盖的决策写入谱系。
    Gemini 不可用时，写入 pending 等待人类（降级，不阻塞）。
    见 `.chanlun/genealogy/settled/041-orchestrator-proxy.md`。
15. **拓扑异步自指蜂群是默认架构。** [新缠论] 不是普通 agent team。
    **真递归拓扑异步自指蜂群是默认模式**（095号谱系，编排者 INTERRUPT 修正）：
    - teammate 通过 TeamCreate 创建子 team → 子 team 内部自治 → 结果向上回传。
    - **子蜂群同样是递归拓扑异步自指蜂群**——子 team 不是简化版 agent pool，它复制父蜂群的完整结构。递归的每一层都是完整蜂群，必须满足五特征（097号 DAG 模板）：拓扑（≥2 并行任务节点）、异步自指（审查节点：t时刻审查t-1）、结晶（结晶节点：产出写入文件）、状态管理（独立 TaskList）、异质验证（异质审计节点：调用 Gemini 或等效异质源，约束4强制）。
    - **创世 Gap 递归化**（097号）：L(n-1) Teammate 执行 sub-swarm-ceremony skill 时充当 L(n) Swarm₀——每层递归都有自己的创世 Gap（094号），这是结构条件不是 bug。
    - **真递归是默认架构模式（不需要理由），扁平 Lead→Worker 是退化特例（使用需要理由——必须证明子任务不需要独立治理）**（105号原始意图 + 116号定理修正：090号严格性语法规则要求声明与实际一致。073b"平台约束前提"已被095号事实否定——平台支持真递归，无需近似）。
    **三框架组合理解**（117号定理，落实104号映射）：蜂群架构不是单一框架，而是三层互补描述——069号=功能架构(what: 递归/拓扑/异步自指/结晶)，093号=物理约束(why: 五约束有向依赖图)，097号=工程模板(how: 五特征DAG模板)。异质验证不是蜂群的功能维度（069号），而是对蜂群的外部校验约束（093号约束4），在工程实现中由异质审计节点（097号五特征之一）覆盖。
    **统一约束（096号谱系，无例外）**：所有 Task 调用必须携带 team_name，无例外（包括 Explore 类型）。需要搜索时：简单搜索用 Glob/Grep/Read 直接工具；多轮自主搜索在 team 内 spawn 搜索 teammate。
    **规则的三层分布式存在形式**（096号谱系；097号 Gemini decide 选项D 精化）：CLAUDE.md（基因组——声明层，含 skill 路径索引）+ hooks（免疫系统——强制层，只做阻断/放行，不提示/不索引）+ skills（可执行知识结晶——知识层）。三层各司其职不越界：CLAUDE.md 声明原则并指向 skill 入口，hooks 只做语法强制，skills 提供可执行流程。
    **子蜂群创建流程**结晶在 `.claude/skills/sub-swarm-ceremony/SKILL.md`——创建子蜂群时必须读取并遵循。
    递归深度工程上限 ≈ 3-4 层（受并发 agent 数、API 成本、视差 Gap 累积限制）。
    三个不可消除的 Gap：创世Gap（Swarm₀游离于拓扑之外，每层递归独立存在）+ 视差Gap（自审查永远有时间差，随深度累积）+ 审计层断裂Gap（外部审计必须经过持久化中介，随深度放大）。
    这三个 Gap 是系统的结构条件，不是 bug。见 069号、094号、095号、096号、097号谱系。
16. **理论洞见影响设计决策，代码自足表达。** 理论洞见只存在于 `.chanlun/genealogy/` 和 `CLAUDE.md`。
    禁止在 `src/` 中出现哲学/精神分析命名（如 `lacan_router.py`）。
    代码的设计意图必须在工程语言中自足表达，不依赖理论回溯。见 069号谱系。
17. **严格性是蜂群的语法规则。** [新缠论] 所有蜂群产出（代码、方案、审计、分析、对话、架构决策）必须严格。
    严格 = 概念清晰 + 声明与实际一致 + 没有未定义的模糊地带。
    非严格的产出在蜂群中是**语法不合法的**——如同 005b 号禁止非对象否定。
    不是"能不能做到"而是"严格的形式是什么"。约束条件不是降低严格性的理由，而是严格表达的边界条件。
    见 `.claude/rules/no-patch-mentality.md`、090号谱系。

## B. 五约束有向依赖图（093号谱系，取代062号R.S.I映射）

元编排的结构性需求从系统物理限制独立推导为五个约束及其有向依赖关系：

| # | 约束 | 来源 | 失效后果 |
|---|------|------|----------|
| 1a | 物理持久化 | agent 临时、上下文有限 | 信息丢失 |
| 1b | 符号可解释性 | 跨实例无共享记忆 | 信息噪声化 |
| 2 | 规则先在性 | spawn 在执行前完成 | 不可预测行为 |
| 3 | 执行不可自观性 | token 单向生成 | 无法即时自修正 |
| 4 | 异质验证必要性 | 同质系统盲点不可自检 | 自我确认循环 |

**拓扑结构**：**核心环路**（1a → 1b → 2 → 3，操作性依赖）+ **审计层**（4，结构性校验）。核心环路是蜂群运转的操作前提链，审计层从外部校验核心环路的盲点。

**异步自指**是约束3（执行不可自观性）的工程表现形式——当前 LLM 不能同步读写自身，因此审查必须异步（t 时刻审查 t-1 时刻的产出）。

**三个不可消除的 Gap**（069号谱系，094号在五约束框架下重新定位）：
- 创世 Gap：Swarm₀ 制定拓扑规则但自身不受拓扑约束（约束2的 bootstrap 破缺）
- 视差 Gap：系统在 t 时刻只能审查 t-1 时刻的自己（约束3 × 约束2的联合推论）
- 审计层断裂 Gap：外部审计者（约束4）必须经过持久化/可解释性（约束1a/1b）中介观察核心环路，无法直接触及执行过程（约束4 → 约束1a/1b 的层间界面属性）

> 历史溯源：062号曾引入 R.S.I 映射，093号从系统物理限制独立推导后确认不同构，R.S.I 退出活跃术语。完整生成-扬弃过程见 062→092→093 谱系链。

## C. 递归节点默认行为（058号谱系）

当前执行节点基于 Spec 立即执行，编排者事后审计 + 运行时中断（INTERRUPT）。
"Lead"不是固定实体——当前节点相对于其子节点是 Lead，相对于父节点是 Worker。

无阻碍执行（默认递归）：
- 基于 dispatch-dag 的工位 spawn/shutdown
- 基于 topology 的任务路由（不做优先级排序，由 topology-manager 决定）
- 语法/编译/Lint 级错误的修复流程启动（分派给 teammates，当前节点不自行执行）
- quality-guard 通过后的 commit（COMMIT_REQUEST → quality-guard + genealogist 批准 → 执行）
- "选择"类决断路由 Gemini decide 模式（041号），不推给人类

必须阻断等待（020号反转条件）：
- 逻辑/断言级测试失败（可能是概念分离信号，不是纯代码错误）
- dispatch-dag 未定义的异常情况
- 修改 CLAUDE.md、核心定义、已结算谱系
- `negation_form: unclassified` 的否定
- 需要缠论领域知识的选择（非定理推导，且 Gemini 无法决断时）

## D. 结构修改模式（069号谱系，073号更新）

蜂群可以直接修改任何文件（原则0）。对核心文件的修改推荐走审查流程（但不强制）：
1. meta-observer 发现矛盾 → 注入 draft-proposal 任务到队列
2. 任务蜂群起草提案 → 提交给 gemini-challenger 进行高阶审查
3. 审查通过 → 直接执行合并。人类通过 ESC 随时中断（INTERRUPT 权）
4. git 追踪所有修改，可回滚

## E. 热启动机制（Warm Start）

蜂群的持续性通过三级恢复保障：

| 级别 | 触发条件 | 恢复方式 | 状态来源 |
|------|----------|----------|----------|
| L0 正常 | 上下文充足 | 蜂群持续运行 | 内存（当前对话） |
| L1 compact | 上下文压缩 | PreCompact 保存 + SessionStart 恢复 | session 文件 |
| L2 新对话 | 上下文彻底耗尽 | 新对话 + ceremony 从 session 文件恢复 | session 文件 + `.chanlun/` |

**L1 — 同会话 compact 恢复**（已实现）：
1. PreCompact 钩子（`.claude/hooks/precompact-save.sh`）：压缩前自动写入蜂群状态到 `*-precompact.md`
2. 压缩后加载最近 session 记录，恢复定义基底、工作进度、待决事项
3. 直接续接中断点，不需要重新 ceremony

**L2 — 跨会话热启动**（已实现）：
1. 当 compact 后上下文依然不足（或会话被关闭/超时），启动新对话
2. 新对话执行 `/ceremony`，ceremony 自动检测 session 记录，切换为**热启动模式**：
   - 版本对比：扫描 `.chanlun/definitions/` 当前版本 vs session 记录版本
   - 差异报告：只报告变更项（`↑`升级/`+`新增/`-`消失），未变更项标记 `=`
   - 跳过已结算且版本未变更的定义的重新验证
   - 直接加载中断点和阻塞项
   - **不等待编排者确认**，直接进入蜂群循环
3. session 文件是跨对话的唯一状态载体，必须在每次 commit 时同步更新

**设计目标**：蜂群永远在线。compact 和新对话都不是中断，而是状态快照+恢复的不同级别。
