# NewChanlun

缠论量化分析引擎 — 从原始 K 线到全球资本流转投影的形式化实现。

## 这个项目是什么

NewChanlun 将**缠中说禅**的技术分析理论形式化为可计算的事件驱动管线。但它不只是一个交易系统。

在形式化过程中，我们发现缠论的笔-线段-中枢-走势结构不是对价格运动的"描述工具"，而是**扩张/收缩辩证运动在价格维度的显现形式**。多空力量就是扩张和收缩的力量——一笔的终结不是因为"买方力量耗尽"，而是扩张在自身逻辑内部生产出了自己的否定。这给缠论"走势必完美"提供了比技术分析深得多的根基。

这个认识催生了两个阶段的工作：

| 阶段 | 目标 | 状态 |
|------|------|------|
| **第一阶段** | 单标的内完备化：从 K 线到买卖点的全递归形式化 | 基本完成 |
| **第二阶段** | 全球资本流转投影：用同一套语法读多容器间的资本分配 | 进行中 |

**第一阶段的完备性是第二阶段的存在条件。**

---

## 第一阶段：单标的形式化引擎

### 四层同构管线

从原始 K 线到走势类型，四层引擎结构相同（事件驱动、增量计算、身份追踪）：

```
原始 K 线
  │
  ▼
包含处理 (a_inclusion.py)       ← K 线合并，消除包含关系
  │
  ▼
分型识别 (a_fractal.py)         ← 顶分型 / 底分型
  │
  ▼
BiEngine (笔引擎)               ← 第一层：分型 → 笔
  │
  ▼
SegmentEngine (线段引擎)        ← 第二层：笔 → 线段（特征序列法）
  │
  ▼
ZhongshuEngine (中枢引擎)      ← 第三层：线段 → 中枢（三段重叠）
  │
  ▼
MoveEngine (走势引擎)           ← 第四层：中枢 → 走势类型（盘整/趋势）
  │
  ▼
背驰检测 (a_divergence.py)      ← MACD 面积比较，力度衰竭信号
  │
  ▼
买卖点 (a_buysellpoint_v1.py)   ← 一二三类买卖点识别
```

### 各层数学原理与哲学基底

每一层不只是"算法步骤"，它是同一个辩证运动在不同分辨率上的显现。数学是形式语法，哲学是发生学原理。

#### 包含处理 — 区间代数

**数学**：区间包含关系 K₁ ⊆ K₂ ⟺ K₂.high ≥ K₁.high ∧ K₂.low ≤ K₁.low。合并是有方向的区间联合运算：向上取 max(high), max(low)；向下取 min(high), min(low)。满足结合律（先左后右递推），不满足传递律（A⊇B, B⊇C ⇏ A⊇C）。单次扫描 O(n)。

**哲学**：从混沌到结构的第一步。完全被包含的 K 线不携带独立的方向信息——它的全部运动范围都被另一根覆盖了。合并不是"丢掉数据"，是辨认出"这两根说的是同一件事"。方向依赖（向上/向下合并规则不同）意味着包含处理不是纯粹的几何操作，而是嵌入了市场语境的语义压缩。

#### 分型 — 离散极值检测

**数学**：离散序列上的局部极值。顶分型：f(n-1).high < f(n).high > f(n+1).high 且 f(n-1).low < f(n).low > f(n+1).low（双条件同时满足）。连续域类比：f'(x)=0 且 f''(x)<0。底分型对称。3 是最小数据需求（构成转折结构至少需要"之前-当前-之后"三个元素），不是阈值。

**哲学**：相位转换点——扩张在自身逻辑内部生产出收缩的结构位置。分型不是价格"到达"了某个水平然后"反转"（那是因果思维），而是运动在此处完成了方向上的质变（结构思维）。这个区分至关重要：因果思维问"为什么涨到这里就跌了"，结构思维问"什么样的结构标志着扩张相位结束"。答案就是分型。

#### 笔 — 单调路径分解

**数学**：分型之间的最大单调子路径（maximal monotone sub-path）。价格序列 P 被分型标记唯一分解为交替的上升/下降段。每一笔连接一个底分型到一个顶分型（向上笔）或顶分型到底分型（向下笔）。新笔定义要求原始 K 线（非包含处理后）至少 5 根，消除退化段问题（谱系 001）。

**哲学**：扩张/收缩的原子单位。**"对象否定对象"**——一笔结束的唯一原因是反向分型（一个对象）的生成，不是超时、不是阈值、不是任何外在条件。"anchor 因超时消失"不是为假的走势描述，是语法上不合法的走势描述（谱系 005a/005b）。这不是一条工程规则，是走势描述语言的语法公理。

#### 线段 — 递归分型检测（特征序列法）

**数学**：向上段取反向（down）笔的 (high, low) 构造**特征序列**，在特征序列上做包含处理，然后检测分型。这是对笔层同一算法的递归应用——用笔的 (high,low) 区间构造"高一级的 K 线"，做同样的包含处理和分型检测。两种分型情况：无缺口（直接结算）、有缺口（需第二特征序列出现任意分型确认）。线段破坏的充要条件：另一个线段生成。

**哲学**：自相似性。同一结构（区间→包含→分型→单调路径）在更高尺度上重复。这不是偶然的巧合，是扩张/收缩辩证运动在不同尺度上的必然显现——如果扩张/收缩是基本运动形式（命题 2），那么这个运动在任何尺度上都会产出相同的结构。"线段被破坏的充要条件就是另一个线段生成"——否定即创造，辩证法的否定之否定。旧段的结束和新段的开始是同一事件的两面。

#### 中枢 — 区间交集与不动点

**数学**：≥3 段连续线段的价格区间取交集。ZD = max(seg_i.low)，ZG = min(seg_i.high)，ZG > ZD（严格正区间）。中枢是价格运动的**不动点区域**——价格在 [ZD, ZG] 内振荡。固定区间策略（D2）：初始 3 段确定 [ZD, ZG] 后不再变化。延伸判定：后续段与 [ZD, ZG] 有交集。突破：段的范围完全脱离 [ZD, ZG]。

**哲学**：多空均衡态。中枢不是"价格区间"，是**运动的暂时均衡**——扩张和收缩力量在此范围内暂时达成平衡。突破意味着均衡被打破——一方的力量超过了另一方能够吸收的范围。中枢的延伸是均衡维持，中枢的突破是均衡破裂。整个过程是：无序运动→结构化（分型/笔/段）→均衡形成（中枢）→均衡破裂（突破）→新均衡→…… 这就是扩张/收缩的节律性开合。

#### 走势类型 — 中枢间拓扑序

**数学**：中心定理二。相邻中枢 C₁、C₂ 的**波动区间**（GG=max(seg.high), DD=min(seg.low)）比较：
- C₂.DD > C₁.GG → 上涨趋势（波动区间严格递增序）
- C₂.GG < C₁.DD → 下跌趋势（波动区间严格递减序）
- 区间重叠 → 截断，不同走势

盘整 = 单中枢（无方向性）。趋势 = ≥2 同向中枢（有方向性）。走势终完美（原理一）：任何走势类型必然完成。走势分解定理：任何走势 = 盘整/上涨/下跌的连接。

**哲学**：方向性从均衡中涌现。单中枢不具方向——它是纯粹的振荡。多个同向中枢构成趋势——方向性不是预设的属性，是从一系列均衡态的拓扑关系中**涌现**出来的。这是**构造层与分类层的分离**（谱系 010）：中枢是构造出来的（自下而上生成），趋势/盘整是分类层（对中枢序列的涌现属性标注）。中枢递归不产出趋势，趋势是对中枢序列的**读**。

#### 背驰 — 力度积分比较

**数学**：MACD 面积作为力度代理量。A/B/C 三段法：A 段（中枢前同向运动）和 C 段（中枢后同向运动）的 MACD 柱子面积积分比较。area(C) < area(A) → 背驰（力度衰竭）。这是对运动"动量"在结构上可比的两个区间上的积分比较，不是简单的指标交叉。

**哲学**：**扩张在自身逻辑内部生产出自己的否定。** 价格可能仍在创新高（形式上仍在扩张），但推动力度已衰竭（实质上的收缩信号已在内部产生）。现象与本质的分离——这就是为什么背驰是必要条件而非充分条件：力度衰竭了（背驰），但方向反转的结构（分型）尚未完成。这给缠论"走势必完美"提供了比技术分析深得多的根基：走势的完成不是外力终止它，是运动自身耗尽了自己的推动力。黑格尔的"确定否定"（bestimmte Negation）——运动不是简单地停下，而是在自身内部产出了反转的条件。

#### 买卖点 — 形式语法的操作终端

**数学**：三类买卖点构成市场操作的完备集（缠师定理）。
- 第一类：趋势背驰后的转折点 — 级别最大、利润空间最大、确认最晚
- 第二类：一类后首次回调的极值点 — 等价于次级别的一类（定律一）
- 第三类：中枢突破后首次回试不回破 ZG/ZD — 确认突破有效

完备性定理：赢利的买卖点只有这三类。升跌完备性定理：所有走势的起止都是某级别的三类买卖点之一。

**哲学**：形式语法的操作结论。如果前面所有层是"读"走势的语法，买卖点就是这套语法产出的"判断句"——可操作的结论。"走势终完美"保证了买卖点必然产生：运动不可能不完成（原理一），完成就产生转折，转折就是买卖点。操作不是对走势的"预测"，是对已完成结构的"辨认"。

#### 级别递归 — 自相似分形栈

**数学**：第 N 层的走势（Move）通过 MoveProtocol 适配为第 N+1 层的"笔"，然后重新运行整条管线（分型→笔→线段→中枢→走势）。RecursiveStack 管理 N 层并发。这是严格的分形结构——同一映射 f 在不同尺度上的迭代 f ∘ f ∘ f ∘ …。区间套 = 沿递归栈从高层往低层精确定位。

**哲学**：**级别 ≠ 时间周期**。1分钟→5分钟→日线是外在的时间框架，级别是内在的递归层级。同一根 1 分钟 K 线同时属于多个级别——它是第 1 层的原始 K 线，也是第 N 层走势的内部组成。时间周期是观察者选择的窗口，级别是运动自身的结构层次。混淆二者是最常见的缠论误读（谱系 006）。

#### 比价与四矩阵 — 从时间到空间的语法扩展

**数学**：A/B 价格直接除，产出新 K 线序列，运行同一管线。K₄ 完全图（动产/不动产/商品/现金 4 顶点，6 条比价边）。每顶点聚合 3 条边方向：|net| ≥ 2 = 共振（流入/流出信号）。守恒约束 Σ(net) = 0（资本不凭空产生/消失）。守恒破缺 = 跨区域资本流动信号。

**哲学**：同一语法，从时间维度扩展到空间维度。比价一笔向上 = 资本从 B 流向 A。中枢 = 两容器间流转暂时均衡。背驰 = 流转动力衰竭。**资本不是"东西"，资本就是流动本身。** 四矩阵不是画了个框往里面放资本，是用流动关系定义顶点的存在。"没有主体站在过程后面。过程就是全部。"（020a 号谱系统摄命题）

---

### 关键设计决策

- **级别 = 递归层级**（level_id），从 1 分钟 K 线为底座无限向上构造。禁止用"日线/30分/5分"等时间周期替代级别定义。（谱系 006）
- **对象否定对象**：一个对象被否定的唯一来源是内在否定或外部对象生成。不允许超时、阈值、或非对象来源的否定。这是走势描述语言的语法规则。（谱系 005a/005b）
- **构造层与分类层分离**：中枢递归是构造层（自下而上生成），趋势/盘整是分类层（涌现属性标注）。两者不混淆。（谱系 010）
- **事件驱动 + 身份追踪**：所有状态变更通过 DomainEvent 传播。每个实体（线段、中枢、走势）有不可变的身份键，跨状态升级保持稳定。（PR-C0.5）

---

## 第二阶段：全球资本流转投影

### 发生学：从比价K线到四矩阵流场

缠师在第 9 课就指出：比价变动构成独立买卖系统，与市场资金流向相关。

我们将这一洞察形式化：

1. **比价 K 线**（`ratio_engine.py`）：A/B 直接除，产出新 K 线序列。这个序列上运行的仍然是第一阶段那套完整语法——分型→笔→线段→中枢→走势。同一语法，不同分辨率。

2. **资本流转语义**：比价一笔向上 = 资本从 B 流向 A。中枢 = 两容器间流转暂时均衡。背驰 = 流转动力衰竭。

3. **四矩阵拓扑**（`matrix_topology.py`）：四个资本容器顶点（动产/不动产/商品/现金）构成完全图 K₄，共 6 条边。每条边上有比价走势。

4. **流转关系**（`flow_relation.py`）：对每个顶点聚合其 3 条边的方向，≥2 条同向 = 共振。强共振（|net|=3）全部边同向，可能对应系统性事件。

5. **守恒约束**：四矩阵中所有顶点 net flow 之和 = 0。这是"资本不凭空产生也不凭空消失"的形式表达。守恒破缺本身是信号——资本流向了四矩阵之外（跨区域流动）。

6. **区间套下钻**：四矩阵比价 → 角内品种 → 具体合约。同一语法，不同分辨率。

### 概念层级

```
跨标的维度：
  L1 筛选层：等价关系（C-1/C-2/C-3）→ "这对比价值不值得看"
  L1 原子层：比价K线 → 比价走势结构 → StrokeFlow（单边方向+力度）
  L2 拓扑层：流转关系 → "资本正从哪个角流出、流向哪些角"
```

---

## 元编排：蜂群方法论

### 为什么需要元编排

形式化缠论的过程中，我们反复遇到**概念矛盾**——不是代码 bug，而是定义之间的冲突、原文多种解读之间的张力、构造层与分类层的混淆。

这些矛盾不是应该被绕过的障碍，而是系统最有价值的产出。每一次矛盾的精确命名和处理都产出了新的概念区分。元编排就是为了系统化地发现、命名和处理这些矛盾而建立的方法论。

### 核心运作原理

元编排的运作原理与缠论本身同构——这不是隐喻，是结构性的同一：

| 维度 | 扩张 | 收缩 | 相位转换点 |
|------|------|------|-----------|
| 资本运动 | 积累、信用扩张 | 去杠杆、清算 | 操盘手 |
| 单标的走势 | 一笔向上 | 一笔向下 | 分型 |
| 比价走势 | 资本从 B 流向 A | 资本从 A 流向 B | 比价分型 |
| 系统运行 | 质询展开、谱系碰撞 | 汇总、仪式、结算 | 编排者 |
| 上下文 | prompt 内知识碰撞 | 结晶为 skill/session/definition | 写 skill 的 agent |

系统中所有循环的终止都是**结构性的**，不是计数性的：背驰（力度衰竭）+ 分型（方向反转）= 结构完成。3 不是阈值，是分型的最小数据量。

### 谱系：概念发现的发动机

谱系不是变更日志。谱系记录的是**否定史**——概念如何被矛盾推动而分化、重组、升级。写谱系的过程本身就是概念发现的来源：多条谱系之间的张力碰撞往往产生最重要的洞察。

例如：谱系 007（趋势是独立实体）、008（趋势确立与级别独立）、009（盘整的双重性）三者之间的张力碰撞，产出了 010 号谱系——构造层与分类层的二层架构。这个洞察不是预先设计的，是写谱系的过程中涌现的。

### 构成性矛盾：系统的脉动

无限发现（谱系 012）与有限预算（上下文窗口）之间的张力不是待解决的 bug，而是系统运转的**构成性矛盾**——辩证法的发动机：

- 纯扩张 = 系统窒息（上下文耗尽，递归无终止）
- 纯收缩 = 系统僵死（谱系退化为日志，不再产出新区分）
- 健康态 = 节律性开合（呼吸）——扩张 → 背驰信号 → 收缩结晶 → 需要时重载

三种结晶维度是同一运动的不同投影：session = 时间结晶，skill = 知识结晶，definition = 概念结晶。

### 分布式指令架构

元编排不是一个中央控制器，而是分布式结晶在 skill 和 agent 中的能力流动：

| 文件 | 职责 |
|------|------|
| `SKILL.md`（核心卡） | 质询序列、概念分离、生成态/结算态 |
| `meta-lead.md` | 薄路由：收信 → 判断类型 → 转发工位 |
| `genealogist.md` | 谱系写入、张力检查、回溯扫描 |
| `source-auditor.md` | 三级权威链、溯源标签、原文考古 |
| `meta-observer.md` | 二阶反馈回路、元编排自身的进化 |
| `quality-guard.md` | 结果包检查、代码违规扫描 |
| `topology-manager.md` | 工位数量的扩张/收缩建议 |

### 三级权威链

缠论原文的权威性按以下顺序递减：

1. **缠师原始博文**（108 课 + 课间答疑）— 最终权威
2. **《股市技术理论》编纂版** — 第三方编纂，有已知遗漏
3. **思维导图 / 第三方总结** — 辅助理解，不作为定义依据

---

## 项目现状

### 数字概览

| 指标 | 数值 |
|------|------|
| 测试用例 | 1300+ passed |
| 核心定义 | 12 条（全部已结算） |
| 已结算谱系 | 38 条 |
| 不变量断言 | 22 条（I1-I22） |
| 规则规范 | 10 份 |

### 定义基底

| 定义 | 版本 | 维度 |
|------|------|------|
| 包含关系 baohan | v1.3 | 单标的 |
| 分型 fenxing | v1.0 | 单标的 |
| 笔 bi | v1.4 | 单标的 |
| 线段 xianduan | v1.3 | 单标的 |
| 中枢 zhongshu | v1.3 | 单标的 |
| 走势类型 zoushi | v1.6 | 单标的 |
| 背驰 beichi | v1.1 | 单标的 |
| 级别递归 level_recursion | v1.0 | 单标的 |
| 买卖点 maimai | v1.0 | 单标的 |
| 比价关系 bijia | v1.0 | 跨标的 |
| 等价关系 dengjia | v1.1 | 跨标的 |
| 流转关系 liuzhuan | v1.0 | 跨标的 |

---

## 快速开始

### 环境要求

- Python >= 3.10
- Node.js >= 18（前端可视化，可选）

### 安装

```bash
git clone https://github.com/xy7365527-lang/NewChanlun.git
cd NewChanlun

python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

pip install -e ".[test]"

cp .env.example .env
# 编辑 .env 填写 API 密钥
```

### 数据获取

```bash
# Databento 历史数据
newchan fetch-db --symbol CL --intervals 1min,1day --start 2020-01-01

# Interactive Brokers 实时数据
newchan fetch --source ibkr --symbol ES --interval 1min

# 合成标的（价差/比价）
newchan synthetic --a CL --b GC --op ratio
```

### 图表可视化

```bash
# 交互式蜡烛图
newchan plot --symbol CL --display-tf 5m

# Web 图表服务
newchan chart --port 8765
```

### 前端开发

```bash
cd frontend && npm install && npm run dev
```

### 运行测试

```bash
pytest                    # 全量测试
pytest -x                 # 遇到失败即停
pytest -m "not slow"      # 跳过慢测试
```

---

## 项目结构

```
src/newchan/
├── a_*.py                 # 纯函数层（A 层）：无状态算法
│   ├── a_inclusion.py     #   包含关系处理
│   ├── a_fractal.py       #   分型识别
│   ├── a_stroke.py        #   笔构造
│   ├── a_segment_v1.py    #   线段（特征序列法）
│   ├── a_zhongshu_v1.py   #   中枢认定
│   ├── a_move_v1.py       #   走势类型实例
│   ├── a_divergence.py    #   背驰检测
│   └── a_buysellpoint_v1.py # 买卖点识别
├── core/recursion/        # 事件驱动引擎层
│   ├── segment_engine.py  #   线段引擎
│   ├── zhongshu_engine.py #   中枢引擎
│   └── move_engine.py     #   走势引擎
├── audit/                 # 不变量检查器（I1-I22）
├── orchestrator/          # 多周期编排
├── events.py              # 领域事件定义
├── types.py               # 核心数据类型
│
├── ratio_engine.py        # 比价K线引擎
├── equivalence.py         # 等价关系验证（L1 筛选层）
├── capital_flow.py        # 资本流向（StrokeFlow）
├── matrix_topology.py     # 四矩阵拓扑（K₄ 完全图）
├── flow_relation.py       # 流转关系（L2 拓扑层）
├── flow_timeline.py       # 流转时间线
│
├── cli.py                 # 命令行入口
├── server.py              # FastAPI 后端
└── data_*.py              # 数据源适配器（IBKR/Databento/AV）

frontend/                  # React + TypeScript 前端
├── src/
│   ├── primitives/        #   TradingView 图元
│   ├── components/        #   UI 组件
│   └── types/             #   TypeScript 类型定义

.chanlun/                  # 概念层基础设施
├── definitions/           #   12 个核心定义（只通过仪式修改）
├── genealogy/             #   谱系记录（38 已结算 + 1 生成态）
│   ├── settled/           #     已结算的概念发现
│   └── pending/           #     生成态矛盾
└── sessions/              #   会话状态快照（热启动用）

docs/spec/                 # 规则规范文档
tests/                     # 测试套件（1300+ 用例）
```

## 数据源

| 数据源 | 用途 | 配置 |
|--------|------|------|
| [Databento](https://databento.com/) | 美股 + 期货历史数据 | `DATABENTO_API_KEY` |
| [Interactive Brokers](https://www.interactivebrokers.com/) | 实时行情 + 交易 | `IB_HOST` / `IB_PORT` |
| [Alpha Vantage](https://www.alphavantage.co/) | 辅助数据 | `ALPHAVANTAGE_API_KEY` |

## 理论来源

- **缠中说禅**：108 课技术分析理论（笔、线段、中枢、走势类型、背驰、买卖点、区间套）
- **卢麒元**：全球资本流转四矩阵拓扑（动产/不动产/商品/现金）
- **本体论基础**（020 号谱系）：扩张/收缩辩证运动作为统一框架，黑格尔构成性矛盾，谢林原初收缩

## 许可证

本项目仅供学习研究使用。缠论相关内容版权归原作者所有。
