# NewChanlun

缠论量化分析引擎 — 从原始 K 线到全球资本流转投影的形式化实现。

## 这个项目是什么

NewChanlun 将**缠中说禅**的技术分析理论形式化为可计算的事件驱动管线。但它不只是一个交易系统。

在形式化过程中，我们发现缠论的笔-线段-中枢-走势结构不是对价格运动的"描述工具"，而是**扩张/收缩辩证运动在价格维度的显现形式**。多空力量就是扩张和收缩的力量——一笔的终结不是因为"买方力量耗尽"，而是扩张在自身逻辑内部生产出了自己的否定。这给缠论"走势必完美"提供了比技术分析深得多的根基。

这个认识催生了两个阶段的工作：

| 阶段 | 目标 | 状态 |
|------|------|------|
| **第一阶段** | 单标的内完备化：从 K 线到买卖点的全递归形式化 | 基本完成 |
| **第二阶段** | 全球资本流转投影：用同一套语法读多容器间的资本分配 | 进行中 |

**第一阶段的完备性是第二阶段的存在条件。**

---

## 第一阶段：单标的形式化引擎

### 四层同构管线

从原始 K 线到走势类型，四层引擎结构相同（事件驱动、增量计算、身份追踪）：

```
原始 K 线
  │
  ▼
包含处理 (a_inclusion.py)       ← K 线合并，消除包含关系
  │
  ▼
分型识别 (a_fractal.py)         ← 顶分型 / 底分型
  │
  ▼
BiEngine (笔引擎)               ← 第一层：分型 → 笔
  │
  ▼
SegmentEngine (线段引擎)        ← 第二层：笔 → 线段（特征序列法）
  │
  ▼
ZhongshuEngine (中枢引擎)      ← 第三层：线段 → 中枢（三段重叠）
  │
  ▼
MoveEngine (走势引擎)           ← 第四层：中枢 → 走势类型（盘整/趋势）
  │
  ▼
背驰检测 (a_divergence.py)      ← MACD 面积比较，力度衰竭信号
  │
  ▼
买卖点 (a_buysellpoint_v1.py)   ← 一二三类买卖点识别
```

### 关键设计决策

- **级别 = 递归层级**（level_id），从 1 分钟 K 线为底座无限向上构造。禁止用"日线/30分/5分"等时间周期替代级别定义。（谱系 006）
- **对象否定对象**：一个对象被否定的唯一来源是内在否定或外部对象生成。不允许超时、阈值、或非对象来源的否定。这是走势描述语言的语法规则。（谱系 005a/005b）
- **构造层与分类层分离**：中枢递归是构造层（自下而上生成），趋势/盘整是分类层（涌现属性标注）。两者不混淆。（谱系 010）
- **事件驱动 + 身份追踪**：所有状态变更通过 DomainEvent 传播。每个实体（线段、中枢、走势）有不可变的身份键，跨状态升级保持稳定。（PR-C0.5）

---

## 第二阶段：全球资本流转投影

### 发生学：从比价K线到四矩阵流场

缠师在第 9 课就指出：比价变动构成独立买卖系统，与市场资金流向相关。

我们将这一洞察形式化：

1. **比价 K 线**（`ratio_engine.py`）：A/B 直接除，产出新 K 线序列。这个序列上运行的仍然是第一阶段那套完整语法——分型→笔→线段→中枢→走势。同一语法，不同分辨率。

2. **资本流转语义**：比价一笔向上 = 资本从 B 流向 A。中枢 = 两容器间流转暂时均衡。背驰 = 流转动力衰竭。

3. **四矩阵拓扑**（`matrix_topology.py`）：四个资本容器顶点（动产/不动产/商品/现金）构成完全图 K₄，共 6 条边。每条边上有比价走势。

4. **流转关系**（`flow_relation.py`）：对每个顶点聚合其 3 条边的方向，≥2 条同向 = 共振。强共振（|net|=3）全部边同向，可能对应系统性事件。

5. **守恒约束**：四矩阵中所有顶点 net flow 之和 = 0。这是"资本不凭空产生也不凭空消失"的形式表达。守恒破缺本身是信号——资本流向了四矩阵之外（跨区域流动）。

6. **区间套下钻**：四矩阵比价 → 角内品种 → 具体合约。同一语法，不同分辨率。

### 概念层级

```
跨标的维度：
  L1 筛选层：等价关系（C-1/C-2/C-3）→ "这对比价值不值得看"
  L1 原子层：比价K线 → 比价走势结构 → StrokeFlow（单边方向+力度）
  L2 拓扑层：流转关系 → "资本正从哪个角流出、流向哪些角"
```

---

## 元编排：蜂群方法论

### 为什么需要元编排

形式化缠论的过程中，我们反复遇到**概念矛盾**——不是代码 bug，而是定义之间的冲突、原文多种解读之间的张力、构造层与分类层的混淆。

这些矛盾不是应该被绕过的障碍，而是系统最有价值的产出。每一次矛盾的精确命名和处理都产出了新的概念区分。元编排就是为了系统化地发现、命名和处理这些矛盾而建立的方法论。

### 核心运作原理

元编排的运作原理与缠论本身同构——这不是隐喻，是结构性的同一：

| 维度 | 扩张 | 收缩 | 相位转换点 |
|------|------|------|-----------|
| 资本运动 | 积累、信用扩张 | 去杠杆、清算 | 操盘手 |
| 单标的走势 | 一笔向上 | 一笔向下 | 分型 |
| 比价走势 | 资本从 B 流向 A | 资本从 A 流向 B | 比价分型 |
| 系统运行 | 质询展开、谱系碰撞 | 汇总、仪式、结算 | 编排者 |
| 上下文 | prompt 内知识碰撞 | 结晶为 skill/session/definition | 写 skill 的 agent |

系统中所有循环的终止都是**结构性的**，不是计数性的：背驰（力度衰竭）+ 分型（方向反转）= 结构完成。3 不是阈值，是分型的最小数据量。

### 谱系：概念发现的发动机

谱系不是变更日志。谱系记录的是**否定史**——概念如何被矛盾推动而分化、重组、升级。写谱系的过程本身就是概念发现的来源：多条谱系之间的张力碰撞往往产生最重要的洞察。

例如：谱系 007（趋势是独立实体）、008（趋势确立与级别独立）、009（盘整的双重性）三者之间的张力碰撞，产出了 010 号谱系——构造层与分类层的二层架构。这个洞察不是预先设计的，是写谱系的过程中涌现的。

### 构成性矛盾：系统的脉动

无限发现（谱系 012）与有限预算（上下文窗口）之间的张力不是待解决的 bug，而是系统运转的**构成性矛盾**——辩证法的发动机：

- 纯扩张 = 系统窒息（上下文耗尽，递归无终止）
- 纯收缩 = 系统僵死（谱系退化为日志，不再产出新区分）
- 健康态 = 节律性开合（呼吸）——扩张 → 背驰信号 → 收缩结晶 → 需要时重载

三种结晶维度是同一运动的不同投影：session = 时间结晶，skill = 知识结晶，definition = 概念结晶。

### 分布式指令架构

元编排不是一个中央控制器，而是分布式结晶在 skill 和 agent 中的能力流动：

| 文件 | 职责 |
|------|------|
| `SKILL.md`（核心卡） | 质询序列、概念分离、生成态/结算态 |
| `meta-lead.md` | 薄路由：收信 → 判断类型 → 转发工位 |
| `genealogist.md` | 谱系写入、张力检查、回溯扫描 |
| `source-auditor.md` | 三级权威链、溯源标签、原文考古 |
| `meta-observer.md` | 二阶反馈回路、元编排自身的进化 |
| `quality-guard.md` | 结果包检查、代码违规扫描 |
| `topology-manager.md` | 工位数量的扩张/收缩建议 |

### 三级权威链

缠论原文的权威性按以下顺序递减：

1. **缠师原始博文**（108 课 + 课间答疑）— 最终权威
2. **《股市技术理论》编纂版** — 第三方编纂，有已知遗漏
3. **思维导图 / 第三方总结** — 辅助理解，不作为定义依据

---

## 项目现状

### 数字概览

| 指标 | 数值 |
|------|------|
| 测试用例 | 1300+ passed |
| 核心定义 | 12 条（全部已结算） |
| 已结算谱系 | 38 条 |
| 不变量断言 | 22 条（I1-I22） |
| 规则规范 | 10 份 |

### 定义基底

| 定义 | 版本 | 维度 |
|------|------|------|
| 包含关系 baohan | v1.3 | 单标的 |
| 分型 fenxing | v1.0 | 单标的 |
| 笔 bi | v1.4 | 单标的 |
| 线段 xianduan | v1.3 | 单标的 |
| 中枢 zhongshu | v1.3 | 单标的 |
| 走势类型 zoushi | v1.6 | 单标的 |
| 背驰 beichi | v1.1 | 单标的 |
| 级别递归 level_recursion | v1.0 | 单标的 |
| 买卖点 maimai | v1.0 | 单标的 |
| 比价关系 bijia | v1.0 | 跨标的 |
| 等价关系 dengjia | v1.1 | 跨标的 |
| 流转关系 liuzhuan | v1.0 | 跨标的 |

---

## 快速开始

### 环境要求

- Python >= 3.10
- Node.js >= 18（前端可视化，可选）

### 安装

```bash
git clone https://github.com/xy7365527-lang/NewChanlun.git
cd NewChanlun

python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

pip install -e ".[test]"

cp .env.example .env
# 编辑 .env 填写 API 密钥
```

### 数据获取

```bash
# Databento 历史数据
newchan fetch-db --symbol CL --intervals 1min,1day --start 2020-01-01

# Interactive Brokers 实时数据
newchan fetch --source ibkr --symbol ES --interval 1min

# 合成标的（价差/比价）
newchan synthetic --a CL --b GC --op ratio
```

### 图表可视化

```bash
# 交互式蜡烛图
newchan plot --symbol CL --display-tf 5m

# Web 图表服务
newchan chart --port 8765
```

### 前端开发

```bash
cd frontend && npm install && npm run dev
```

### 运行测试

```bash
pytest                    # 全量测试
pytest -x                 # 遇到失败即停
pytest -m "not slow"      # 跳过慢测试
```

---

## 项目结构

```
src/newchan/
├── a_*.py                 # 纯函数层（A 层）：无状态算法
│   ├── a_inclusion.py     #   包含关系处理
│   ├── a_fractal.py       #   分型识别
│   ├── a_stroke.py        #   笔构造
│   ├── a_segment_v1.py    #   线段（特征序列法）
│   ├── a_zhongshu_v1.py   #   中枢认定
│   ├── a_move_v1.py       #   走势类型实例
│   ├── a_divergence.py    #   背驰检测
│   └── a_buysellpoint_v1.py # 买卖点识别
├── core/recursion/        # 事件驱动引擎层
│   ├── segment_engine.py  #   线段引擎
│   ├── zhongshu_engine.py #   中枢引擎
│   └── move_engine.py     #   走势引擎
├── audit/                 # 不变量检查器（I1-I22）
├── orchestrator/          # 多周期编排
├── events.py              # 领域事件定义
├── types.py               # 核心数据类型
│
├── ratio_engine.py        # 比价K线引擎
├── equivalence.py         # 等价关系验证（L1 筛选层）
├── capital_flow.py        # 资本流向（StrokeFlow）
├── matrix_topology.py     # 四矩阵拓扑（K₄ 完全图）
├── flow_relation.py       # 流转关系（L2 拓扑层）
├── flow_timeline.py       # 流转时间线
│
├── cli.py                 # 命令行入口
├── server.py              # FastAPI 后端
└── data_*.py              # 数据源适配器（IBKR/Databento/AV）

frontend/                  # React + TypeScript 前端
├── src/
│   ├── primitives/        #   TradingView 图元
│   ├── components/        #   UI 组件
│   └── types/             #   TypeScript 类型定义

.chanlun/                  # 概念层基础设施
├── definitions/           #   12 个核心定义（只通过仪式修改）
├── genealogy/             #   谱系记录（38 已结算 + 1 生成态）
│   ├── settled/           #     已结算的概念发现
│   └── pending/           #     生成态矛盾
└── sessions/              #   会话状态快照（热启动用）

docs/spec/                 # 规则规范文档
tests/                     # 测试套件（1300+ 用例）
```

## 数据源

| 数据源 | 用途 | 配置 |
|--------|------|------|
| [Databento](https://databento.com/) | 美股 + 期货历史数据 | `DATABENTO_API_KEY` |
| [Interactive Brokers](https://www.interactivebrokers.com/) | 实时行情 + 交易 | `IB_HOST` / `IB_PORT` |
| [Alpha Vantage](https://www.alphavantage.co/) | 辅助数据 | `ALPHAVANTAGE_API_KEY` |

## 理论来源

- **缠中说禅**：108 课技术分析理论（笔、线段、中枢、走势类型、背驰、买卖点、区间套）
- **卢麒元**：全球资本流转四矩阵拓扑（动产/不动产/商品/现金）
- **本体论基础**（020 号谱系）：扩张/收缩辩证运动作为统一框架，黑格尔构成性矛盾，谢林原初收缩

## 许可证

本项目仅供学习研究使用。缠论相关内容版权归原作者所有。
