# 等价关系 v1 — 形式化规范

> 状态：设计稿 v1.0
> 日期：2026-02-18
> 前置：ontology-v1.md 命题5, ratio_relation_v1.md
> 溯源：[旧缠论] 比价关系前置条件（第9课隐含）；[新缠论] 等价关系纯结构定义 + 实体不变量原则

---

## 0. 设计原则：实体作为不变量

等价关系的判定**不依赖实体身份**。

给定两列 OHLCV 价格序列 A 和 B，等价关系只检查它们之间的**结构性质**。A 是黄金 ETF、B 是白银 ETF——这些信息不参与等价判定。等价关系不关心容器是什么，只关心容器之间的结构关系是否满足条件。

**本体论依据**：如果资本运动是根本性的（ontology-v1 命题1），那具体资产只是容器。容器的身份不重要，重要的是流动的结构。实体作为不变量是这一命题在形式层面的表达。

**推论**：任何对实体身份的分类（替代品、同行业竞品、宏观资产类别等）都是**事后标注**，不是等价判定的输入。你可以在等价对成立之后标注它属于哪种类型，但这个标注不参与判定。

---

## 1. 判定标准

### 1.1 输入

两列同周期 OHLCV 价格序列，记为 A 和 B。不要求任何元数据（名称、行业、资产类别等）。

### 1.2 三个条件

两列序列构成**等价对**，当且仅当同时满足：

**C-1（可比性）**：A 和 B 有足够多的重叠时间点。

```
overlap(A, B) = |timestamps(A) ∩ timestamps(B)|
C-1 成立 ⟺ overlap(A, B) ≥ T_overlap
```

> T_overlap：最小重叠时间点数。待从真实数据确定。
> 直觉：重叠太少则比价序列太短，无法产出有效走势结构。

**C-2（非退化）**：A/B 比价不是常数。

```
ratio(t) = A.close(t) / B.close(t)
C-2 成立 ⟺ variation(ratio) ≥ T_variation
```

> variation 的度量方式和 T_variation 阈值：待从真实数据确定。
> 候选度量：标准差/均值（变异系数）、最大值/最小值之比、或其他。
> 直觉：比价为常数（或近常数）时，比价K线退化为平线，无走势结构。

**C-3（流动性）**：A 和 B 都有充足的成交量。

```
C-3 成立 ⟺ median_volume(A) ≥ T_volume ∧ median_volume(B) ≥ T_volume
```

> T_volume：最小中位成交量。待从真实数据确定。
> 直觉：无量标的的价格反映噪音而非资本流转。比价中的噪音成分越大，走势结构越不可靠。

### 1.3 阈值状态

| 阈值 | 定义 | 当前值 | 来源 |
|------|------|--------|------|
| T_overlap | 最小重叠时间点 | **待定** | 需从 §6 验证数据中确定 |
| T_variation | 最小比价变异 | **待定** | 需从 §6 验证数据中确定 |
| T_volume | 最小中位成交量 | **待定** | 需从 §6 验证数据中确定 |

> 阈值不是从规范推导出来的，是从真实市场数据里长出来的。规范定义结构，数据填充参数。

---

## 2. 数学性质

### 2.1 不自反

A/A = 1（常数），不满足 C-2。因此任何序列与自身不构成等价对。

```
¬Equiv(A, A)
```

### 2.2 对称性

如果 A/B 满足三个条件，则 B/A 也满足三个条件。

```
Equiv(A, B) ⟺ Equiv(B, A)
```

**证明**：
- C-1：overlap 是对称的
- C-2：A/B 非常数 ⟺ B/A 非常数（互为倒数）
- C-3：双方流动性条件不依赖顺序

### 2.3 不传递

```
Equiv(A, B) ∧ Equiv(B, C) ⇏ Equiv(A, C)
```

**反例构造**：
- A 和 B 有完全重叠的交易时间、充足的比价变异和流动性 → Equiv(A, B) ✓
- B 和 C 同上 → Equiv(B, C) ✓
- 但 A 和 C 可能交易时间不重叠（如 A 是 A 股、C 是美股、B 是港股同时在两个市场交易）→ Equiv(A, C) ✗

不传递性意味着等价关系不是数学上的等价关系，更接近"可比较关系"。保留"等价"名称是因为缠论原文使用此术语。

### 2.4 性质总结

| 性质 | 成立？ | 原因 |
|------|--------|------|
| 自反性 | ✗ | A/A = 常数，违反 C-2 |
| 对称性 | ✓ | 三个条件都不依赖顺序 |
| 传递性 | ✗ | 交易时间重叠不传递 |

---

## 3. 与四矩阵的映射

### 3.1 等价对 → 四矩阵边

四矩阵的 6 条边（ratio_relation_v1.md §3）各代表一种资本容器之间的比价。**每条边是一个等价对**。

```
四矩阵边 ⊂ 等价对
```

四矩阵的边一定满足等价关系（否则该边无意义），但满足等价关系的对不一定是四矩阵的边（例如 GLD/SLV 是等价对但不是四矩阵的边）。

### 3.2 映射方向

```
等价判定（纯结构） → 等价对成立 → 可选: 映射到四矩阵
```

映射是**事后的**。先判定等价，再看这对等价对是否对应四矩阵的某条边。不是先确定四矩阵的边再判断它们是否等价。

### 3.3 事后标注

等价对成立后，可以标注元数据：

| 标注 | 说明 | 参与判定？ |
|------|------|-----------|
| 类型（替代品/竞品/…） | 描述性分类 | **否** |
| 四矩阵位置 | 对应哪条边 | **否** |
| 区域 | 属于哪个经济体 | **否** |

这些标注服务于人类理解和系统组织，不参与等价判定。

---

## 4. 与已有实现的关系

### 4.1 当前实现

```python
# equivalence.py
EquivalencePair(sym_a, sym_b, category)  # category 可降为可选标注
validate_pair(df_a, df_b) → ValidationResult(valid, reason)
```

### 4.2 需要调整

| 项目 | 当前 | 规范要求 |
|------|------|---------|
| `validate_pair` 阈值 | 硬编码猜测值 | 从真实数据确定后回填 |
| `EquivalencePair.category` | 必填感 | 改为可选标注 |
| `validate_pair` 返回值 | `valid` + `reason` | 考虑返回三个条件的具体度量值 |

### 4.3 不需要修改

- `make_ratio_kline`：纯结构操作，不涉及等价判定
- 全部管线模块：等价关系对管线透明

---

## 5. 边界条件

- **B 价格为 0**：除法无意义。C-1 的 overlap 计算应排除 B=0 的时间点。
- **极短序列**：overlap 满足但序列太短，管线可能无法产出有效走势结构。T_overlap 应设置得足够大以避免此问题。
- **单边流动性缺失**：A 有量但 B 无量。C-3 要求双方都有量。
- **比价近常数但不严格常数**：T_variation 的边界。需要数据来确定"近常数"的定义。

---

## 6. 阈值确定计划

从已有的真实数据中提取经验边界：

| 数据对 | 类型 | 已缓存 | 用途 |
|--------|------|--------|------|
| GLD/SLV | 有效等价对 | ✅ | 正例：确定有效对的特征范围 |
| SPY/TLT | 有效等价对 | ✅ | 正例：不同类型的有效对 |
| SPY/GLD | 有效等价对 | ✅ | 正例：跨资产有效对 |
| 退化对 | 构造/寻找 | ❌ | 反例：确定阈值下界 |

**缺失**：目前只有正例（已知有效的等价对）。需要反例（不满足条件的对）来确定阈值的边界在哪里。

可能的反例来源：
- 同一标的不同份额（如 GLD/IAU，两个黄金 ETF，比价可能近常数 → 测试 C-2 边界）
- 极低流动性标的 → 测试 C-3 边界
- 不同市场不同交易时间 → 测试 C-1 边界

---

## 附录：溯源标注

| 概念 | 溯源 | 说明 |
|------|------|------|
| 比价关系前置条件 | [旧缠论:隐含] | 第9课隐含（买卖系统需要有效的比价输入） |
| 三个条件的结构化定义 | [新缠论] | 本规范首次显式化 |
| 实体作为不变量 | [新缠论] | 等价判定不依赖实体身份 |
| 分类降格为事后标注 | [新缠论] | 实体不变量原则的推论 |
| 不传递性 | [新缠论] | ratio_relation_v1.md §2.1 首次指出 |
