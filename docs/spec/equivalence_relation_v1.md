# 等价关系 v1 — 形式化规范

> 状态：设计稿 v1.1（§1 阈值从数据中确定）
> 日期：2026-02-18（v1.1 更新）
> 前置：ontology-v1.md 命题5, ratio_relation_v1.md
> 溯源：[旧缠论] 比价关系前置条件（第9课隐含）；[新缠论] 等价关系纯结构定义 + 实体不变量原则
> genealogy_source: 023-equivalence-relation-formalization, 024-c2-three-layer-degeneracy, 025-equivalence-demotion-to-screening

---

## 0. 设计原则：实体作为不变量

等价关系的判定**不依赖实体身份**。

给定两列 OHLCV 价格序列 A 和 B，等价关系只检查它们之间的**结构性质**。A 是黄金 ETF、B 是白银 ETF——这些信息不参与等价判定。等价关系不关心容器是什么，只关心容器之间的结构关系是否满足条件。

**本体论依据**：如果资本运动是根本性的（ontology-v1 命题1），那具体资产只是容器。容器的身份不重要，重要的是流动的结构。实体作为不变量是这一命题在形式层面的表达。

**推论**：任何对实体身份的分类（替代品、同行业竞品、宏观资产类别等）都是**事后标注**，不是等价判定的输入。你可以在等价对成立之后标注它属于哪种类型，但这个标注不参与判定。

---

## 1. 判定标准

### 1.1 输入

两列同周期 OHLCV 价格序列，记为 A 和 B。不要求任何元数据（名称、行业、资产类别等）。

### 1.2 三个条件

两列序列构成**等价对**，当且仅当同时满足：

**C-1（可比性）**：A 和 B 有足够多的重叠时间点。

```
overlap(A, B) = |timestamps(A) ∩ timestamps(B)|
C-1 成立 ⟺ overlap(A, B) ≥ T_overlap
```

> T_overlap：最小重叠时间点数。待从真实数据确定。
> 直觉：重叠太少则比价序列太短，无法产出有效走势结构。

**C-2（非退化）**：A/B 比价序列能产出承载资本流转语义的走势结构。

非退化判定采用**三层退化连锁检测**：

退化是连锁的：K线波动小 → 笔力度弱 → MACD面积趋零 → 背驰判定退化为随机。三层全部用缠论自身的语法或其直接统计投影，零外部阈值。

| 层 | 度量 | 来源 | 成本 | 退化表现 |
|----|------|------|------|---------|
| 预筛 | CV | 统计量（不跑缠论） | 极低 | CV ≈ 0（价格锁定） |
| 结构层 | 笔力度 mean_pct | 缠论语法输出 | 中 | 笔力度 < 0.5%（微振动） |
| 动力层 | MACD 面积 / 背驰可判定性 | 缠论动力学 | 高 | 面积趋零 → 背驰判定退化 |

**第一层：快速预筛（CV 预筛）**

```
ratio(t) = A.close(t) / B.close(t)
CV = std(ratio) / mean(ratio)
预筛通过 ⟺ CV ≥ T_cv
```

> T_cv = 0.01。这不是精确调参的结果，是真实数据中涌现的**自然断裂**——正例 CV ∈ [0.043, 0.078]，反例 CV = 0.00048，两个数量级的无人区使得阈值放在 0.001–0.04 之间的任何位置都给出相同的分类结果。预筛不是裁判，是成本优化：避免对显然退化的序列跑完整管线。预筛是漏斗不是门——错杀（false negative）可接受，误放由裁判层兜底。

**第二层：结构退化检测（结构层裁判）**

对预筛通过的序列运行管线（包含→分型→笔），检查笔力度：

```
strokes = pipeline(ratio_kline(A, B))
mean_pct = mean(|s.p1/s.p0 - 1| for s in strokes)
结构非退化 ⟺ mean_pct ≥ T_stroke_pct
```

> T_stroke_pct = 0.5%（0.005）。实证来源见 §6.2。正例笔力度均值 ∈ [5.2%, 6.1%]，反例 = 0.054%，差距 ~100 倍。
>
> 这一层的意义：缠论语法在**任何** K 线序列上都能产出结构（GLD/IAU 产出了 15 笔），但不是所有结构都承载资本流转的语义。笔力度低于阈值说明走势结构是噪音的产物，不是资本运动的投影。C-2 不是管线的前置过滤器，是**语义的门槛**。
>
> **为什么用笔力度而不是固定 CV 作为裁判**：固定数值阈值是外加的——和"数到 3"是同一种思维模式。笔力度是缠论语法自身产出的度量，让语法判定自己的输出是否有意义。

**第三层：动力退化检测（动力层裁判）**

对结构层通过的序列计算 MACD，检查面积结构和背驰可判定性：

```
macd = compute_macd(ratio_kline(A, B))
hist = macd["hist"]
norm_hist_mean = |hist|.mean() / ratio.close.mean()
动力非退化 ⟺ norm_hist_mean ≥ T_dynamics_pct
```

> T_dynamics_pct = 0.01%（0.0001）。实证来源见 §6.2。正例归一化 |hist| 均值 = 0.33%，反例 = 0.0018%，差距 ~183 倍。
>
> 这一层的意义：MACD 面积是缠论动力学的度量——面积趋零意味着背驰判定退化为随机。反例 GLD/IAU 的 MACD 在零附近高频震荡（252 bar 内 60 次零轴穿越 vs 正例 21 次），面积段比值范围 [0.008, 212]（std=36.0 vs 正例 3.0），背驰判定在反例中无区分力。
>
> **层间关系**：预筛是漏斗（快速排除明显退化），结构层和动力层是裁判（语法自判定）。三层连锁确认退化的一致性：CV 极小 → 笔力度极弱 → MACD 面积趋零 → 背驰判定退化。

**C-3（流动性）**：A 和 B 都有充足的成交量。

```
C-3 成立 ⟺ median_volume(A) ≥ T_volume ∧ median_volume(B) ≥ T_volume
```

> T_volume：最小中位成交量。待从真实数据确定。
> 直觉：无量标的的价格反映噪音而非资本流转。比价中的噪音成分越大，走势结构越不可靠。

### 1.3 阈值状态

| 阈值 | 定义 | 当前值 | 来源 |
|------|------|--------|------|
| T_overlap | 最小重叠时间点 | **120** | 经验值：≈6个月日线，确保比价序列足够长以产出走势结构 |
| T_cv | CV 预筛阈值 | **0.01** | §6.2 自然断裂：正例 [0.043, 0.078] vs 反例 0.00048 |
| T_stroke_pct | 最小笔力度均值 | **0.005** | §6.2 结构退化检测：正例 [0.043, 0.061] vs 反例 0.00054 |
| T_volume | 最小中位成交量 | **100,000** | 保守下限，确保价格反映真实交易而非噪音 |

> 阈值不是从规范推导出来的，是从真实市场数据里长出来的。规范定义结构，数据填充参数。
>
> T_cv 和 T_stroke_pct 都设在正例和反例之间的**自然无人区**内。无人区的存在意味着阈值的精确值不敏感——这是 robust 的阈值，不是过拟合。
>
> T_overlap 和 T_volume 目前是经验估值（当前数据集均为美股 ETF，252 个交易日完全重叠，流动性均 >1M），需要跨市场数据（A股/港股/加密货币）来压力测试边界。

---

## 2. 数学性质

### 2.1 不自反

A/A = 1（常数），不满足 C-2。因此任何序列与自身不构成等价对。

```
¬Equiv(A, A)
```

### 2.2 对称性

如果 A/B 满足三个条件，则 B/A 也满足三个条件。

```
Equiv(A, B) ⟺ Equiv(B, A)
```

**证明**：
- C-1：overlap 是对称的
- C-2：A/B 非常数 ⟺ B/A 非常数（互为倒数）
- C-3：双方流动性条件不依赖顺序

### 2.3 不传递

```
Equiv(A, B) ∧ Equiv(B, C) ⇏ Equiv(A, C)
```

**反例构造**：
- A 和 B 有完全重叠的交易时间、充足的比价变异和流动性 → Equiv(A, B) ✓
- B 和 C 同上 → Equiv(B, C) ✓
- 但 A 和 C 可能交易时间不重叠（如 A 是 A 股、C 是美股、B 是港股同时在两个市场交易）→ Equiv(A, C) ✗

不传递性意味着等价关系不是数学上的等价关系，更接近"可比较关系"。保留"等价"名称是因为缠论原文使用此术语。

### 2.4 性质总结

| 性质 | 成立？ | 原因 |
|------|--------|------|
| 自反性 | ✗ | A/A = 常数，违反 C-2 |
| 对称性 | ✓ | 三个条件都不依赖顺序 |
| 传递性 | ✗ | 交易时间重叠不传递 |

---

## 3. 与四矩阵的映射

### 3.1 等价对 → 四矩阵边

四矩阵的 6 条边（ratio_relation_v1.md §3）各代表一种资本容器之间的比价。**每条边是一个等价对**。

```
四矩阵边 ⊂ 等价对
```

四矩阵的边一定满足等价关系（否则该边无意义），但满足等价关系的对不一定是四矩阵的边（例如 GLD/SLV 是等价对但不是四矩阵的边）。

### 3.2 映射方向

```
等价判定（纯结构） → 等价对成立 → 可选: 映射到四矩阵
```

映射是**事后的**。先判定等价，再看这对等价对是否对应四矩阵的某条边。不是先确定四矩阵的边再判断它们是否等价。

### 3.3 事后标注

等价对成立后，可以标注元数据：

| 标注 | 说明 | 参与判定？ |
|------|------|-----------|
| 类型（替代品/竞品/…） | 描述性分类 | **否** |
| 四矩阵位置 | 对应哪条边 | **否** |
| 区域 | 属于哪个经济体 | **否** |

这些标注服务于人类理解和系统组织，不参与等价判定。

---

## 4. 与已有实现的关系

### 4.1 当前实现

```python
# equivalence.py
EquivalencePair(sym_a, sym_b, category)  # category 可降为可选标注
validate_pair(df_a, df_b) → ValidationResult(valid, reason)
```

### 4.2 需要调整

| 项目 | 当前 | 规范要求 |
|------|------|---------|
| `validate_pair` 阈值 | 硬编码猜测值 | 从真实数据确定后回填 |
| `EquivalencePair.category` | 必填感 | 改为可选标注 |
| `validate_pair` 返回值 | `valid` + `reason` | 考虑返回三个条件的具体度量值 |

### 4.3 不需要修改

- `make_ratio_kline`：纯结构操作，不涉及等价判定
- 全部管线模块：等价关系对管线透明

---

## 5. 边界条件

- **B 价格为 0**：除法无意义。C-1 的 overlap 计算应排除 B=0 的时间点。
- **极短序列**：overlap 满足但序列太短，管线可能无法产出有效走势结构。T_overlap 应设置得足够大以避免此问题。
- **单边流动性缺失**：A 有量但 B 无量。C-3 要求双方都有量。
- **比价近常数但不严格常数**：双层判定的设计正是为了处理这个边界。CV 预筛在自然断裂处划线（两个数量级的无人区），结构退化检测用缠论语法自身的笔力度作为最终裁判。GLD/IAU（CV=0.00048, 笔力度均值=0.054%）是这个边界的实证反例。

---

## 6. 实证验证

### 6.1 数据集

| 数据对 | 类型 | 缓存 | 用途 | 数据源 |
|--------|------|------|------|--------|
| GLD/SLV | 正例（替代品） | ✅ | 有效等价对的特征范围 | Alpha Vantage 2024 日线 |
| SPY/TLT | 正例（宏观资产） | ✅ | 反向标的等价对 | Alpha Vantage 2024 日线 |
| SPY/GLD | 正例（跨资产） | ✅ | 四矩阵等价对 | Alpha Vantage 2024 日线 |
| GLD/IAU | **反例**（近常数） | ✅ | C-2 边界的实证 | Alpha Vantage 2024 日线 |

### 6.2 C-2 实证结果

#### CV 预筛（第一层）

| 数据对 | CV | range_ratio | 分类 |
|--------|-----|-------------|------|
| GLD/SLV | 0.0468 | 1.251 | 正例 |
| SPY/TLT | 0.0781 | 1.442 | 正例 |
| SPY/GLD | 0.0434 | 1.208 | 正例 |
| GLD/IAU | **0.000480** | **1.002** | 反例 |

正例 CV ∈ [0.043, 0.078]，反例 CV = 0.00048。**两个数量级的无人区**（0.00048 — 0.043），T_cv = 0.01 位于无人区正中。

#### 结构退化检测（第二层）

| 数据对 | 笔数 | 线段数 | 笔力度均值 | 笔力度最大 | 分类 |
|--------|------|--------|-----------|-----------|------|
| GLD/SLV | 24 | 4 | 5.25% | 15.69% | 正例 |
| SPY/TLT | 18 | 2 | 6.11% | 17.68% | 正例 |
| SPY/GLD | 17 | 2 | 5.86% | 13.32% | 正例 |
| GLD/IAU | 15 | 1 | **0.054%** | **0.135%** | 反例 |

关键发现：

1. **缠论语法在任何序列上都产出结构**。GLD/IAU 产出了 15 笔——语法本身不拒绝任何输入。
2. **但结构的力度揭示语义**。正例笔力度均值 ∈ [5.2%, 6.1%]，反例 = 0.054%，差距 ~100 倍。
3. **结构退化 = 噪音的走势**。GLD/IAU 的 15 笔全部在 4.885–4.897 的 0.2% 窄带内振荡。这是价格噪音产出的分型/笔，不是资本流转的投影。

**定理级发现**：C-2 不是管线的前置过滤器，是**语义的门槛**。等价对的判定不是"能不能跑缠论"，而是"跑出来的缠论结构是否对应真实的资本运动"。

#### 动力退化检测（第三层）

| 数据对 | 归一化\|hist\|均值 | 零轴穿越/252bar | 面积段比值std | 分类 |
|--------|-------------------|-----------------|-------------|------|
| GLD/SLV | 0.33% | 21 | 3.0 | 正例 |
| GLD/IAU | **0.0018%** | **60** | **36.0** | 反例 |

正例/反例归一化 MACD 面积差距：**~183 倍**。

关键发现：

1. **面积绝对量**：正例最小有意义面积段（0.054）vs 反例最大面积段（0.0024）= 22.3 倍。断裂清晰。
2. **背驰判定退化**：反例的相邻面积段比值范围 [0.008, 212]，正例 [0.1, 12]。反例的段间关系是纯随机，背驰判定在其上无区分力。
3. **零轴穿越频率**：反例 60 次 vs 正例 21 次。反例的 MACD 在零附近高频震荡——噪声的典型特征。
4. **三层连锁一致**：CV 极小（0.00048）→ 笔力度极弱（0.054%）→ MACD 面积趋零（0.0018%）→ 背驰判定退化。退化在三个独立度量上同步出现，相互印证。

### 6.3 C-1 / C-3 状态

| 条件 | 当前数据 | 状态 |
|------|----------|------|
| C-1（重叠） | 所有对均 252/252 = 100% 重叠 | 未受压力测试（均为美股 ETF）|
| C-3（流动性） | 最低中位量 = IAU 4.8M | 未有低流动性反例 |

**待补充反例**：
- C-1：跨市场对（A股/港股/美股，交易日历不同）
- C-3：低流动性标的（日成交量 <10 万股的个股）

---

## 7. 概念张力：等价关系的本体论地位（已决断 — 025号谱系）

### 7.1 缠师的三独立系统

缠师**没有**等价关系这个概念。他的操作方式是：A 是一个独立系统，B 是一个独立系统，A/B 是一个独立系统。三个系统各自跑缠论，各自产出走势结构，各自给出买卖点。不需要先判断 A 和 B 是否"等价"才能看 A/B。

```
[旧缠论] A系统 ⊥ B系统 ⊥ A/B系统（三独立）
```

### 7.2 推论：C-1/C-2/C-3 的性质重定位

三个条件不是"等价关系的判定条件"，而是**"哪些比价系统值得看"的筛选条件**。性质完全不同：

- 等价关系：预设两个对象之间存在某种本体论上的关系
- 筛选条件：只是说"这个比价系统的走势结构是否有交易价值"

而"走势结构是否有交易价值"这件事，缠论自己就能判断——GLD/IAU 的结构退化检测（§6.2）正是缠论语法对自身输出的自判定。

### 7.3 L2 的需求：从等价对到流转关系

对于全球资本流转的形式化（L2 目标），仅有三独立系统不够——需要知道**哪些比价系统在描述同一股资本运动**。但这不是经典的等价关系（对称、一对一），而是：

- **一对多**：一个角（如商品角）的收缩走势可能同时对应三条比价线（商品/动产、商品/现金、商品/不动产）
- **有方向**：A/B 上升 = 资本从 B 流向 A，流转是有方向的
- **共振涌现**：多条比价走势同方向运动 = 资本从一个角同时向多个角流出

**已决断（025号谱系）**：编排者确认 C-1/C-2/C-3 是**筛选条件**，不是本体关系。L2 的资本流转形式化由**流转关系**（定义 #14, `liuzhuan.md`）独立承担——四矩阵上的有向流场，从每条边的比价走势方向聚合涌现。本规范继续使用"等价"术语（缠师原文术语），但其性质已明确为筛选。

---

## 附录：溯源标注

| 概念 | 溯源 | 说明 |
|------|------|------|
| 比价关系前置条件 | [旧缠论:隐含] | 第9课隐含（买卖系统需要有效的比价输入） |
| 三独立系统 | [旧缠论] | 缠师的操作方式：A⊥B⊥A/B |
| 三个条件的结构化定义 | [新缠论] | 本规范首次显式化（筛选条件，非本体关系） |
| 实体作为不变量 | [新缠论] | 等价判定不依赖实体身份 |
| 分类降格为事后标注 | [新缠论] | 实体不变量原则的推论 |
| 不传递性 | [新缠论] | ratio_relation_v1.md §2.1 首次指出 |
| C-2 三层退化连锁检测 | [新缠论] | CV 预筛 + 结构层（笔力度）+ 动力层（MACD面积/背驰可判定性） |
| 筛选条件 vs 本体关系 | [新缠论] | 三条件是筛选而非等价判定 |
| 流转关系（L2） | [新缠论] | 已结算为独立定义 #14（liuzhuan.md）：四矩阵有向流场 |
