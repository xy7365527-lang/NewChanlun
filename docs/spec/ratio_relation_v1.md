# 比价关系与等价关系 v1 — 空间维度形式化规范

> 状态：设计稿 v1.0
> 日期：2026-02-18
> 前置：ontology-v1.md 命题5, move_rules_v1.md, zhongshu_rules_v1.md
> 溯源：[旧缠论:隐含] 比价关系为三个独立系统之一（第72/73课）；[新缠论] 比价K线形式化 + 等价关系定义 + 四矩阵拓扑

---

## 0. 问题陈述

第一阶段实现了单标的走势分析的完备链：

```
K线 → 分型 → 笔 → 线段 → 中枢 → 走势 → 背驰 → 买卖点
```

同一套形式语法可以应用于**任何满足 OHLCV 格式的价格序列**。这意味着：给定两个标的 A 和 B，其比价序列 A/B 也是一个合法的价格序列，可以直接输入已有管线。

ontology-v1 命题5：
> 形式化路径：A/B 比价直接除 → K线 → 走势 → 缠论结构。
> 区间套下钻：四矩阵比价 → 角内品种 → 具体合约。同一语法，不同分辨率。

本规范将这一路径形式化为可实现的规范。

---

## 1. 比价K线

### 1.1 构造 [新缠论]

给定两个标的 A、B 的同周期 OHLCV 序列，比价K线定义为：

```
ratio_open  = A.open  / B.open
ratio_high  = A.high  / B.high
ratio_low   = A.low   / B.low
ratio_close = A.close / B.close
ratio_volume = A.volume  （成交量取主标的）
```

**前置条件**：A 和 B 必须有对齐的时间戳（同交易日/同时间窗口）。缺失的时间点应对齐剔除或前值填充（策略可配置）。

**已有实现**：`src/newchan/synthetic.py::make_ratio()` 已实现此构造。

### 1.2 语义 [新缠论]

比价K线上的缠论结构携带**资本流转**语义：

| 单标的概念 | 比价对应 | 资本流转含义 |
|-----------|---------|------------|
| 一笔向上 | 比价一笔向上 | A 相对于 B 升值 = 资本从 B 流向 A |
| 一笔向下 | 比价一笔向下 | A 相对于 B 贬值 = 资本从 A 流向 B |
| 中枢 | 比价中枢 | A、B 之间资本流转暂时均衡 |
| 背驰 | 比价背驰 | 资本流转动力衰竭 |
| 走势完成 | 比价走势完成 | A/B 之间的一段资本流转运动结束 |
| 买卖点 | 比价买卖点 | 配置 A vs B 的最佳时机 |

### 1.3 不变量 [新缠论]

- **IR-1**（对称性）：A/B 比价上涨 ⟺ B/A 比价下跌。两个方向的走势结构互为镜像。
- **IR-2**（独立性）：比价走势独立于 A 或 B 各自的走势。A 上涨 + B 上涨更快 → 比价下跌。
- **IR-3**（完备性）：比价K线满足走势必完美（继承自已有管线，不需要额外证明）。

---

## 2. 等价关系

### 2.1 定义 [新缠论]

两个标的 A、B 构成**等价对**（equivalence pair），当且仅当：

1. **可比性**：A 和 B 有重叠的交易时间窗口（能构造对齐的K线序列）
2. **非退化**：A/B 比价不是常数（否则比价K线退化为平线，无走势结构）
3. **流动性**：A 和 B 都有充足的市场深度（否则比价反映的不是资本流转，而是流动性噪音）

等价关系是**自反的**（A/A = 1，退化，不满足条件2）、**对称的**（A/B 可比 ⟺ B/A 可比）、但**不传递**（A/B 有意义 + B/C 有意义 ≠ A/C 有意义——例如黄金/原油有意义，原油/玉米有意义，但黄金/玉米可能无意义）。

> 注：等价关系严格来说不是数学上的等价关系（不传递），更接近"可比较关系"。保留"等价"名称是因为缠论原文使用此术语。

### 2.2 等价对的分类 [新缠论]

| 类型 | 示例 | 特征 |
|------|------|------|
| 同行业竞品 | 可口可乐/百事 | 比价波动范围有限，中枢明确 |
| 替代品 | 黄金/白银 | 比价有长期趋势+区间 |
| 宏观资产类别 | 股票/债券（SPY/TLT） | 反映风险偏好变化 |
| 跨区域同品 | A股/H股同公司 | 反映资本管制和套利空间 |
| 四矩阵边 | 动产/不动产 | 反映宏观资本流转格局 |

---

## 3. 四矩阵拓扑 [新缠论]

### 3.1 框架（引用卢麒元）

资本容器的四个顶点：

```
    动产（股票、基金）
      /          \
现金 —————————— 不动产（房地产）
      \          /
    商品（大宗、黄金）
```

4个顶点构成 C(4,2) = 6 条比价边。每条边代表一对等价关系。

### 3.2 比价边定义

| 边 | 代表性等价对 | 资本流转含义 |
|----|------------|------------|
| 动产/现金 | SPY/USD（或指数绝对值） | 股市整体涨跌 |
| 不动产/现金 | 房价指数/CPI | 实际房价变化 |
| 商品/现金 | CRB/USD | 实物通胀 |
| 动产/不动产 | SPY/XLRE | 金融资产 vs 实物资产偏好 |
| 动产/商品 | SPY/GLD | 金融资产 vs 避险资产 |
| 商品/不动产 | GLD/XLRE | 实物之间的配置偏好 |

### 3.3 区域维度

四矩阵在**每个经济体**中独立存在。跨经济体的比价反映**全球资本流转**：

```
区间套下钻路径：
  四矩阵比价（宏观方向）
    → 角内品种（行业/板块）
      → 具体合约（个股/期货）
```

同一语法，不同分辨率。

---

## 4. 与已有管线的集成

### 4.1 数据流

```
数据源 (Databento/IBKR/AV)
  → fetch_ohlcv(sym_a), fetch_ohlcv(sym_b)
    → make_ratio(df_a, df_b)  ← 已实现
      → 标准管线: BiEngine → SegmentEngine → ... → BuySellPointEngine
        → 比价走势结构
```

**关键点**：已有管线不需要任何修改。比价K线是标准 OHLCV，直接输入即可。

### 4.2 需要新增的模块

| 模块 | 功能 | 优先级 |
|------|------|--------|
| `equivalence.py` | 等价对管理（定义、验证、注册） | P1 |
| `ratio_engine.py` | 多对比价的并行分析调度 | P2 |
| `capital_flow.py` | 比价走势 → 资本流转方向推断 | P2 |
| `matrix_topology.py` | 四矩阵拓扑管理 | P3 |

### 4.3 不需要修改的模块

- 全部单级别管线（a_*.py）
- 递归引擎（core/recursion/）
- 区间套搜索（a_nested_divergence.py）
- 数据获取（data_*.py）
- 前端图表（b_chart.py, frontend/）

---

## 5. 边界条件

- **比价为0或∞**：B 价格为 0（退市/停牌）时比价无意义。需要过滤。
- **时间对齐**：不同交易所交易时间不同（如 A股 vs 美股）。需要显式对齐策略。
- **数据频率**：比价K线的周期由两个标的中频率较低者决定。
- **包含处理**：比价K线的包含处理与单标的完全相同（继承已有定义 baohan v1.3）。

---

## 6. 验证计划

1. **阶段一**：选一对高相关标的（如 GLD/SLV），生成比价K线，验证管线输出合理性
2. **阶段二**：选一对反向标的（如 SPY/TLT），验证比价走势结构与市场直觉一致
3. **阶段三**：四矩阵中选 2-3 条边，验证跨资产类别比价

---

## 附录：溯源标注

| 概念 | 溯源 | 原文出处 |
|------|------|---------|
| 比价关系（作为独立系统） | [旧缠论] | 第72/73课 |
| A/B 直接除构造比价K线 | [新缠论] | ontology-v1 命题5 |
| 比价走势语义（资本流转） | [新缠论] | ontology-v1 命题5 |
| 等价关系定义 | [新缠论] | 本规范首次形式化 |
| 四矩阵拓扑 | [新缠论] | 引用卢麒元框架 + ontology-v1 命题5 |
| 区间套空间扩展 | [新缠论] | ontology-v1 命题5 |
