# 097号决策报告：真严格递归拓扑异步自指蜂群的完整架构

**日期**: 2026-02-22
**决断类型**: 选择（架构级）
**编排者指令**: "真严格递归拓扑异步自指蜂群的存在，那么整个架构应该是怎么样的，这是一个严格架构，不要有什么余地"
**异质质询**: Gemini 3.1 Pro Preview（decide 模式）+ 本代理反向质询

---

## 1. 结论（六要素之一）

### Gemini 决策结论

**方案 X+Z 综合：分形 DAG + 免疫排斥架构**

核心四点：
1. **规则存在形式**：CLAUDE.md（全息基因组）+ hooks（免疫排斥系统）+ skills（操作结晶）——三层是理论极限，禁止通过 prompt 传递结构性规则
2. **拓扑真递归**：子蜂群必须显式生成局部 `sub-dispatch-dag-<id>.yaml`（无局部 DAG = 不是真蜂群）
3. **创世 Gap 递归化**：L(n-1) Teammate 执行 sub-swarm-ceremony skill，充当 L(n) 的 Swarm₀
4. **对象否定对象验证**：新增 `team-topology-guard.sh` hook，在子蜂群启动前解析局部 DAG，缺少"异质审计节点"或"异步自指节点"则直接阻断

### 本代理质询结论

**Gemini 的方向性结论成立，但实现路径需要修正。**

具体：
- ✅ **成立**：三层规则存在形式（CLAUDE.md + hooks + skills）是分布式环境下的理论极限
- ✅ **成立**：子蜂群创世 Gap 的递归化——L(n-1) Teammate 充当 L(n) Swarm₀
- ✅ **成立**：约束4（异质验证）在子蜂群中的强制性
- ⚠️ **需要修正**：运行时动态生成 `sub-dispatch-dag-<id>.yaml` 的实现路径
  - 问题：动态生成的 YAML 文件的存在论地位与 dispatch-dag.yaml（genome_layer 文件，预先提交到 git）不同构
  - 修正：sub-dispatch-dag 的**结构模板**在 sub-swarm-ceremony skill 中静态声明；hook 验证的是子蜂群的 TaskList 是否包含必要节点类型（拓扑节点 + 异步自指节点 + 异质审计节点），而非验证 YAML 文件是否存在
- ⚠️ **风险保留**："自身免疫性疾病"（hook 过严导致 L1 死锁）是真实风险，需要在 hook 设计中明确边界条件

---

## 2. 定义依据（六要素之二）

### 核心定义引用

**069号**（递归拓扑异步自指蜂群）：
- "每层完整结构"——子蜂群不是 agent pool，是完整蜂群
- 四维度：递归 + 拓扑（DAG）+ 异步自指 + 蜂群（并行）

**089号**（严格扬弃）：
- 规则三层存在形式：CLAUDE.md（基因组）+ hooks（免疫系统）+ skills（知识结晶）
- 禁止 prompt 传递结构性规则

**093号**（五约束）：
- 约束4（异质验证必要性）：同质系统盲点不可自检 → 自我确认循环
- 子蜂群封闭执行而不调用 Gemini = 违反约束4

**094号**（三个 Gap）：
- 创世 Gap = 约束2 bootstrap 破缺（瞬时，每次 ceremony 发生）
- 子蜂群有自己的创世 Gap（095号明确：每层递归都有自己的创世 Gap）

**096号**（无例外）：
- 规则不在 prompt 中 = 分布式
- 无例外 = 语法规则不可降级

**005b号**（对象否定对象）：
- 验证机制必须是对象否定对象，不能是超时/阈值

---

## 3. 边界条件（六要素之三）

在以下条件下，本结论翻转或需要修正：

| 条件 | 翻转方向 |
|------|---------|
| Claude Code 平台不允许 teammate 使用 TeamCreate | 真递归不可行，回退 Trampoline（095号边界条件） |
| Hook 无法区分"子蜂群必要节点类型"（缺乏 TaskList 结构可检查性） | 验证从 hook 层降级到 skill 层（sub-swarm-ceremony 自检） |
| 递归深度超过 3-4 层导致视差 Gap 累积显著 | 强制设置硬性深度上限（095号工程上限）|
| 异质验证（Gemini）在子蜂群中因 MCP 工具不可用 | 约束4降级为父蜂群事后审计（审计层断裂 Gap 扩大）|
| "自身免疫性疾病"：hook 过严 L1 死锁 | 修正 hook 为"异常记录 + 父蜂群通知"而非"阻断" |

---

## 4. 下游推论（六要素之四）

若本决策成立：

1. **sub-swarm-ceremony skill 需要更新**：
   - 新增"子蜂群内部必须包含异质审计节点"的显式要求
   - 提供子蜂群 TaskList 的最小拓扑模板（四节点：任务节点 + 审查节点 + 结晶节点 + 异质审计节点）

2. **hooks 可能需要新增**：
   - `team-topology-guard.sh`（Gemini 建议）：验证子蜂群 TaskList 包含必要节点类型
   - 但必须解决"如何在 hook 中可靠检查 TaskList 结构"的技术问题

3. **CLAUDE.md 原则15 需要更新**：
   - 从"真递归受深度 ≈ 3-4 层限制"
   - 到"真递归 + 每层子蜂群必须满足四特征（拓扑/异步自指/结晶/异质验证）"

4. **创世 Gap 的递归形式化**：
   - 094号需要补充"创世 Gap 在子蜂群中的瞬时破缺表现"
   - sub-swarm-ceremony = 子 Swarm₀ 的显式化

5. **异质验证下沉**：
   - 约束4在子蜂群中的最小实现方式需要明确
   - 候选：子蜂群 Lead 在汇总前调用 gemini-challenger 验证关键产出

---

## 5. 谱系引用（六要素之五）

直接前置谱系：
- 069号：递归拓扑异步自指蜂群——四维度定义
- 089号：元编排严格扬弃——规则三层存在形式
- 093号：五约束有向依赖图——约束4异质验证必要性
- 094号：三个 Gap 重新定位——每层递归的创世 Gap
- 095号：Agent Team 真递归——子蜂群同样是完整蜂群
- 096号：无例外——规则必须分布式存在，不在 prompt 中

关联谱系：
- 005b号：对象否定对象——验证机制的合法性约束
- 090号：严格性是蜂群语法规则——不接受补丁方案
- 058号：ceremony 是 Swarm₀——创世 Gap 的来源

---

## 6. 影响声明（六要素之六）

### 本决策产出的修改

#### 需要修改的文件

**A. sub-swarm-ceremony SKILL.md（最重要）**
新增子蜂群最小拓扑要求：
- TaskList 必须包含以下节点类型：
  1. 任务节点（至少2个，支持并行——拓扑约束）
  2. 审查节点（异步自指——t 时刻审查 t-1 产出）
  3. 结晶节点（产出写入文件，向上回传）
  4. 异质审计节点（调用 Gemini challenger 或等效异质源）
- 这是子蜂群的最小 DAG 结构，不是建议

**B. CLAUDE.md 原则15**
更新子蜂群的四特征描述，明确每层必须满足约束4（异质验证）

**C. team-topology-guard.sh（新 hook——可选，需权衡"自身免疫"风险）**
在 TeamCreate 后（PostToolUse）验证子蜂群创建者是否已经加载 sub-swarm-ceremony skill
（注意：这比 Gemini 建议的"验证 YAML 文件"更轻量，且不需要动态生成 YAML）

#### 不修改的文件

- agent-team-enforce.sh：已无例外，不需要修改
- dispatch-dag.yaml：genome_layer 声明已足够，子蜂群的 sub-dispatch-dag 问题通过 skill 内的模板解决

---

## Gemini 原始推理链（完整摘要）

1. **概念优先于代码**：子蜂群仅被"告知"要表现得像蜂群留下了 LLM 幻觉的余地。真严格必须是结构上的不可逾越
2. **真递归同构**：L0 有 dispatch-dag + ceremony，L(n) 必须有同构的 sub-dispatch-dag + sub-swarm-ceremony
3. **对象否定对象**：Hook（对象）否定不合规的 DAG（对象），不依赖超时/阈值
4. **约束4的必然性**：子蜂群没有异质审计节点 = 封闭自证循环 = 违反约束4

**Gemini 识别的关键风险**：
- 自身免疫性疾病（hook 过严导致 L1 死锁）
- 创世 Gap 无限嵌套（L(n-1) 能力不足则子蜂群出生即畸形）

---

## 本代理的修正建议（综合质询结论）

### 修正1：sub-dispatch-dag 的实现路径

Gemini 建议运行时动态生成 `sub-dispatch-dag-<id>.yaml`，但这引入了与 dispatch-dag.yaml（genome_layer 静态文件）的存在论不一致。

**修正方案**：
- sub-dispatch-dag **结构模板**以 YAML 形式写入 sub-swarm-ceremony skill 中（静态声明）
- 每个子蜂群实例化时，参考模板创建 TaskList（TaskCreate 调用），而不是写 YAML 文件
- hook 验证 TaskList 是否包含四类节点，而非验证 YAML 文件是否存在

这样：
- 模板是分布式的（skill 文件，全层级可加载）
- 实例化是运行时的（TaskList，随 team 生命周期存在）
- 验证是对象化的（hook 解析 TaskList API 返回值）

### 修正2："自身免疫"风险的缓解

hook 的行为应该是：
- **阻断**：Task(无 team_name)（已实现，agent-team-enforce.sh）
- **通知 + 等待**：子蜂群启动时缺少必要节点类型（不是直接阻断，而是向父蜂群 Lead 发送警告）
- **原因**：硬阻断会让子蜂群在创建阶段即死锁，违反"对象否定对象"——因为此时子蜂群尚未形成，没有可以被否定的对象

### 核心结论（最终）

**097号最强架构 = 089号三层存在形式（已实现）+ 子蜂群四特征最小 DAG 模板（在 skill 中声明）+ 异质验证强制化（约束4在每层的最小实现）**

现有机制（CLAUDE.md + hooks + skills）已实现规则分布式存在。当前缺口是：
1. sub-swarm-ceremony skill 没有明确声明"异质审计节点"为必须节点
2. 子蜂群创世 Gap 的形式化需要在 skill 中显式描述（L(n-1) 充当 L(n) 的 Swarm₀）

这两点是执行动作的落脚点。
